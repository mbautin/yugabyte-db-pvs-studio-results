
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>sst_file_writer.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//  Copyright (c) 2011-present, Facebook, Inc.  All rights reserved.</a>
<a name="ln2">//  This source code is licensed under the BSD-style license found in the</a>
<a name="ln3">//  LICENSE file in the root directory of this source tree. An additional grant</a>
<a name="ln4">//  of patent rights can be found in the PATENTS file in the same directory.</a>
<a name="ln5">//</a>
<a name="ln6">// The following only applies to changes made to this file as part of YugaByte development.</a>
<a name="ln7">//</a>
<a name="ln8">// Portions Copyright (c) YugaByte, Inc.</a>
<a name="ln9">//</a>
<a name="ln10">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except</a>
<a name="ln11">// in compliance with the License.  You may obtain a copy of the License at</a>
<a name="ln12">//</a>
<a name="ln13">// http://www.apache.org/licenses/LICENSE-2.0</a>
<a name="ln14">//</a>
<a name="ln15">// Unless required by applicable law or agreed to in writing, software distributed under the License</a>
<a name="ln16">// is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express</a>
<a name="ln17">// or implied.  See the License for the specific language governing permissions and limitations</a>
<a name="ln18">// under the License.</a>
<a name="ln19">//</a>
<a name="ln20"> </a>
<a name="ln21">#include &quot;yb/rocksdb/sst_file_writer.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;vector&gt;</a>
<a name="ln24">#include &quot;yb/rocksdb/db/dbformat.h&quot;</a>
<a name="ln25">#include &quot;yb/rocksdb/db/filename.h&quot;</a>
<a name="ln26">#include &quot;yb/rocksdb/table.h&quot;</a>
<a name="ln27">#include &quot;yb/rocksdb/table/block_based_table_builder.h&quot;</a>
<a name="ln28">#include &quot;yb/rocksdb/util/file_reader_writer.h&quot;</a>
<a name="ln29">#include &quot;yb/util/string_util.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">namespace rocksdb {</a>
<a name="ln32"> </a>
<a name="ln33">const char ExternalSstFilePropertyNames::kVersion[] =</a>
<a name="ln34">    &quot;rocksdb.external_sst_file.version&quot;;</a>
<a name="ln35"> </a>
<a name="ln36">// PropertiesCollector used to add properties specific to tables</a>
<a name="ln37">// generated by SstFileWriter</a>
<a name="ln38">class SstFileWriter::SstFileWriterPropertiesCollector</a>
<a name="ln39">    : public IntTblPropCollector {</a>
<a name="ln40"> public:</a>
<a name="ln41">  explicit SstFileWriterPropertiesCollector(int32_t version)</a>
<a name="ln42">      : version_(version) {}</a>
<a name="ln43"> </a>
<a name="ln44">  virtual Status InternalAdd(const Slice&amp; key, const Slice&amp; value,</a>
<a name="ln45">                             uint64_t file_size) override {</a>
<a name="ln46">    // Intentionally left blank. Have no interest in collecting stats for</a>
<a name="ln47">    // individual key/value pairs.</a>
<a name="ln48">    return Status::OK();</a>
<a name="ln49">  }</a>
<a name="ln50"> </a>
<a name="ln51">  Status Finish(UserCollectedProperties* properties) override {</a>
<a name="ln52">    std::string version_val;</a>
<a name="ln53">    PutFixed32(&amp;version_val, static_cast&lt;int32_t&gt;(version_));</a>
<a name="ln54">    properties-&gt;insert({ExternalSstFilePropertyNames::kVersion, version_val});</a>
<a name="ln55">    return Status::OK();</a>
<a name="ln56">  }</a>
<a name="ln57"> </a>
<a name="ln58">  const char* Name() const override {</a>
<a name="ln59">    return &quot;SstFileWriterPropertiesCollector&quot;;</a>
<a name="ln60">  }</a>
<a name="ln61"> </a>
<a name="ln62">  UserCollectedProperties GetReadableProperties() const override {</a>
<a name="ln63">    return {{ExternalSstFilePropertyNames::kVersion, ToString(version_)}};</a>
<a name="ln64">  }</a>
<a name="ln65"> </a>
<a name="ln66"> private:</a>
<a name="ln67">  int32_t version_;</a>
<a name="ln68">};</a>
<a name="ln69"> </a>
<a name="ln70">class SstFileWriter::SstFileWriterPropertiesCollectorFactory</a>
<a name="ln71">    : public IntTblPropCollectorFactory {</a>
<a name="ln72"> public:</a>
<a name="ln73">  explicit SstFileWriterPropertiesCollectorFactory(int32_t version)</a>
<a name="ln74">      : version_(version) {}</a>
<a name="ln75"> </a>
<a name="ln76">  virtual IntTblPropCollector* CreateIntTblPropCollector(</a>
<a name="ln77">      uint32_t column_family_id) override {</a>
<a name="ln78">    return new SstFileWriterPropertiesCollector(version_);</a>
<a name="ln79">  }</a>
<a name="ln80"> </a>
<a name="ln81">  const char* Name() const override {</a>
<a name="ln82">    return &quot;SstFileWriterPropertiesCollector&quot;;</a>
<a name="ln83">  }</a>
<a name="ln84"> </a>
<a name="ln85"> private:</a>
<a name="ln86">  int32_t version_;</a>
<a name="ln87">};</a>
<a name="ln88"> </a>
<a name="ln89">struct SstFileWriter::Rep {</a>
<a name="ln90">  Rep(const EnvOptions&amp; _env_options, const ImmutableCFOptions&amp; _ioptions,</a>
<a name="ln91">      const Comparator* _user_comparator)</a>
<a name="ln92">      : env_options(_env_options),</a>
<a name="ln93">        ioptions(_ioptions),</a>
<a name="ln94">        internal_comparator(std::make_shared&lt;InternalKeyComparator&gt;(_user_comparator)) {}</a>
<a name="ln95"> </a>
<a name="ln96">  std::unique_ptr&lt;WritableFileWriter&gt; base_file_writer;</a>
<a name="ln97">  std::unique_ptr&lt;WritableFileWriter&gt; data_file_writer;</a>
<a name="ln98">  std::unique_ptr&lt;TableBuilder&gt; builder;</a>
<a name="ln99">  EnvOptions env_options;</a>
<a name="ln100">  ImmutableCFOptions ioptions;</a>
<a name="ln101">  InternalKeyComparatorPtr internal_comparator;</a>
<a name="ln102">  ExternalSstFileInfo file_info;</a>
<a name="ln103">};</a>
<a name="ln104"> </a>
<a name="ln105">SstFileWriter::SstFileWriter(const EnvOptions&amp; env_options,</a>
<a name="ln106">                             const ImmutableCFOptions&amp; ioptions,</a>
<a name="ln107">                             const Comparator* user_comparator)</a>
<a name="ln108">    : rep_(new Rep(env_options, ioptions, user_comparator)) {}</a>
<a name="ln109"> </a>
<a name="ln110">SstFileWriter::~SstFileWriter() { delete rep_; }</a>
<a name="ln111"> </a>
<a name="ln112">Status SstFileWriter::Open(const std::string&amp; file_path) {</a>
<a name="ln113">  Rep* r = rep_;</a>
<a name="ln114">  Status s;</a>
<a name="ln115">  const bool is_split_sst = r-&gt;ioptions.table_factory-&gt;IsSplitSstForWriteSupported();</a>
<a name="ln116">  std::unique_ptr&lt;WritableFile&gt; base_sst_file;</a>
<a name="ln117">  std::unique_ptr&lt;WritableFile&gt; data_sst_file;</a>
<a name="ln118">  s = r-&gt;ioptions.env-&gt;NewWritableFile(file_path, &amp;base_sst_file, r-&gt;env_options);</a>
<a name="ln119">  if (!s.ok()) {</a>
<a name="ln120">    return s;</a>
<a name="ln121">  }</a>
<a name="ln122">  if (is_split_sst) {</a>
<a name="ln123">    s = r-&gt;ioptions.env-&gt;NewWritableFile(TableBaseToDataFileName(file_path), &amp;data_sst_file,</a>
<a name="ln124">        r-&gt;env_options);</a>
<a name="ln125">    if (!s.ok()) {</a>
<a name="ln126">      return s;</a>
<a name="ln127">    }</a>
<a name="ln128">  }</a>
<a name="ln129"> </a>
<a name="ln130">  CompressionType compression_type = r-&gt;ioptions.compression;</a>
<a name="ln131">  if (!r-&gt;ioptions.compression_per_level.empty()) {</a>
<a name="ln132">    // Use the compression of the last level if we have per level compression</a>
<a name="ln133">    compression_type = *(r-&gt;ioptions.compression_per_level.rbegin());</a>
<a name="ln134">  }</a>
<a name="ln135"> </a>
<a name="ln136">  IntTblPropCollectorFactories int_tbl_prop_collector_factories;</a>
<a name="ln137">  int_tbl_prop_collector_factories.emplace_back(</a>
<a name="ln138">      new SstFileWriterPropertiesCollectorFactory(1 /* version */));</a>
<a name="ln139"> </a>
<a name="ln140">  TableBuilderOptions table_builder_options(r-&gt;ioptions,</a>
<a name="ln141">                                            r-&gt;internal_comparator,</a>
<a name="ln142">                                            int_tbl_prop_collector_factories,</a>
<a name="ln143">                                            compression_type,</a>
<a name="ln144">                                            r-&gt;ioptions.compression_opts,</a>
<a name="ln145">                                            false);</a>
<a name="ln146">  r-&gt;base_file_writer.reset(</a>
<a name="ln147">      new WritableFileWriter(std::move(base_sst_file), r-&gt;env_options));</a>
<a name="ln148">  if (is_split_sst) {</a>
<a name="ln149">    r-&gt;data_file_writer.reset(</a>
<a name="ln150">        new WritableFileWriter(std::move(data_sst_file), r-&gt;env_options));</a>
<a name="ln151">  }</a>
<a name="ln152">  r-&gt;builder.reset(r-&gt;ioptions.table_factory-&gt;NewTableBuilder(</a>
<a name="ln153">      table_builder_options,</a>
<a name="ln154">      TablePropertiesCollectorFactory::Context::kUnknownColumnFamily,</a>
<a name="ln155">      r-&gt;base_file_writer.get(), r-&gt;data_file_writer.get()));</a>
<a name="ln156"> </a>
<a name="ln157">  r-&gt;file_info.file_path = file_path;</a>
<a name="ln158">  r-&gt;file_info.file_size = 0;</a>
<a name="ln159">  r-&gt;file_info.base_file_size = 0;</a>
<a name="ln160">  r-&gt;file_info.is_split_sst = is_split_sst;</a>
<a name="ln161">  r-&gt;file_info.num_entries = 0;</a>
<a name="ln162">  r-&gt;file_info.sequence_number = 0;</a>
<a name="ln163">  r-&gt;file_info.version = 1;</a>
<a name="ln164">  return s;</a>
<a name="ln165">}</a>
<a name="ln166"> </a>
<a name="ln167">Status SstFileWriter::Add(const Slice&amp; user_key, const Slice&amp; value) {</a>
<a name="ln168">  Rep* r = rep_;</a>
<a name="ln169">  if (!r-&gt;builder) {</a>
<a name="ln170">    return STATUS(InvalidArgument, &quot;File is not opened&quot;);</a>
<a name="ln171">  }</a>
<a name="ln172"> </a>
<a name="ln173">  if (r-&gt;file_info.num_entries == 0) {</a>
<a name="ln174">    r-&gt;file_info.smallest_key = user_key.ToString();</a>
<a name="ln175">  } else {</a>
<a name="ln176">    if (r-&gt;internal_comparator-&gt;user_comparator()-&gt;Compare(</a>
<a name="ln177">            user_key, r-&gt;file_info.largest_key) &lt;= 0) {</a>
<a name="ln178">      // Make sure that keys are added in order</a>
<a name="ln179">      return STATUS(InvalidArgument, &quot;Keys must be added in order&quot;);</a>
<a name="ln180">    }</a>
<a name="ln181">  }</a>
<a name="ln182"> </a>
<a name="ln183">  // update file info</a>
<a name="ln184">  r-&gt;file_info.num_entries++;</a>
<a name="ln185">  r-&gt;file_info.largest_key = user_key.ToString();</a>
<a name="ln186">  r-&gt;file_info.file_size = r-&gt;builder-&gt;TotalFileSize();</a>
<a name="ln187"> </a>
<a name="ln188">  InternalKey ikey(user_key, 0 /* Sequence Number */,</a>
<a name="ln189">                   ValueType::kTypeValue /* Put */);</a>
<a name="ln190">  r-&gt;builder-&gt;Add(ikey.Encode(), value);</a>
<a name="ln191"> </a>
<a name="ln192">  return Status::OK();</a>
<a name="ln193">}</a>
<a name="ln194"> </a>
<a name="ln195">Status SstFileWriter::Finish(ExternalSstFileInfo* file_info) {</a>
<a name="ln196">  Rep* r = rep_;</a>
<a name="ln197">  if (!r-&gt;builder) {</a>
<a name="ln198">    return STATUS(InvalidArgument, &quot;File is not opened&quot;);</a>
<a name="ln199">  }</a>
<a name="ln200">  if (r-&gt;file_info.num_entries == 0) {</a>
<a name="ln201">    return STATUS(InvalidArgument, &quot;Cannot create sst file with no entries&quot;);</a>
<a name="ln202">  }</a>
<a name="ln203"> </a>
<a name="ln204">  Status s = r-&gt;builder-&gt;Finish();</a>
<a name="ln205">  if (s.ok()) {</a>
<a name="ln206">    if (!r-&gt;ioptions.disable_data_sync) {</a>
<a name="ln207">      s = r-&gt;base_file_writer-&gt;Sync(r-&gt;ioptions.use_fsync);</a>
<a name="ln208">      if (s.ok() &amp;&amp; r-&gt;data_file_writer) {</a>
<a name="ln209">        s = r-&gt;data_file_writer-&gt;Sync(r-&gt;ioptions.use_fsync);</a>
<a name="ln210">      }</a>
<a name="ln211">    }</a>
<a name="ln212">    if (s.ok()) {</a>
<a name="ln213">      s = r-&gt;base_file_writer-&gt;Close();</a>
<a name="ln214">    }</a>
<a name="ln215">    if (s.ok() &amp;&amp; r-&gt;data_file_writer) {</a>
<a name="ln216">      s = r-&gt;data_file_writer-&gt;Close();</a>
<a name="ln217">    }</a>
<a name="ln218">  } else {</a>
<a name="ln219">    r-&gt;builder-&gt;Abandon();</a>
<a name="ln220">  }</a>
<a name="ln221"> </a>
<a name="ln222">  if (!s.ok()) {</a>
<a name="ln223">    r-&gt;ioptions.env-&gt;CleanupFile(r-&gt;file_info.file_path);</a>
<a name="ln224">  }</a>
<a name="ln225"> </a>
<a name="ln226">  if (s.ok() &amp;&amp; file_info != nullptr) {</a>
<a name="ln227">    r-&gt;file_info.file_size = r-&gt;builder-&gt;TotalFileSize();</a>
<a name="ln228">    r-&gt;file_info.base_file_size = r-&gt;builder-&gt;BaseFileSize();</a>
<a name="ln229">    *file_info = r-&gt;file_info;</a>
<a name="ln230">  }</a>
<a name="ln231"> </a>
<a name="ln232">  r-&gt;builder.reset();</a>
<a name="ln233">  return s;</a>
<a name="ln234">}</a>
<a name="ln235">}  // namespace rocksdb</a>

</code></pre>
<div class="balloon" rel="137"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1023/" target="_blank">V1023</a> A pointer without owner is added to the 'int_tbl_prop_collector_factories' container by the 'emplace_back' method. A memory leak will occur in case of an exception.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
