
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>master-path-handlers.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">// Licensed to the Apache Software Foundation (ASF) under one</a>
<a name="ln2">// or more contributor license agreements.  See the NOTICE file</a>
<a name="ln3">// distributed with this work for additional information</a>
<a name="ln4">// regarding copyright ownership.  The ASF licenses this file</a>
<a name="ln5">// to you under the Apache License, Version 2.0 (the</a>
<a name="ln6">// &quot;License&quot;); you may not use this file except in compliance</a>
<a name="ln7">// with the License.  You may obtain a copy of the License at</a>
<a name="ln8">//</a>
<a name="ln9">//   http://www.apache.org/licenses/LICENSE-2.0</a>
<a name="ln10">//</a>
<a name="ln11">// Unless required by applicable law or agreed to in writing,</a>
<a name="ln12">// software distributed under the License is distributed on an</a>
<a name="ln13">// &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</a>
<a name="ln14">// KIND, either express or implied.  See the License for the</a>
<a name="ln15">// specific language governing permissions and limitations</a>
<a name="ln16">// under the License.</a>
<a name="ln17">//</a>
<a name="ln18">// The following only applies to changes made to this file as part of YugaByte development.</a>
<a name="ln19">//</a>
<a name="ln20">// Portions Copyright (c) YugaByte, Inc.</a>
<a name="ln21">//</a>
<a name="ln22">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except</a>
<a name="ln23">// in compliance with the License.  You may obtain a copy of the License at</a>
<a name="ln24">//</a>
<a name="ln25">// http://www.apache.org/licenses/LICENSE-2.0</a>
<a name="ln26">//</a>
<a name="ln27">// Unless required by applicable law or agreed to in writing, software distributed under the License</a>
<a name="ln28">// is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express</a>
<a name="ln29">// or implied.  See the License for the specific language governing permissions and limitations</a>
<a name="ln30">// under the License.</a>
<a name="ln31">//</a>
<a name="ln32"> </a>
<a name="ln33">#include &quot;yb/master/master-path-handlers.h&quot;</a>
<a name="ln34"> </a>
<a name="ln35">#include &lt;algorithm&gt;</a>
<a name="ln36">#include &lt;array&gt;</a>
<a name="ln37">#include &lt;functional&gt;</a>
<a name="ln38">#include &lt;map&gt;</a>
<a name="ln39">#include &lt;iomanip&gt;</a>
<a name="ln40">#include &lt;unordered_set&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#include &quot;yb/common/partition.h&quot;</a>
<a name="ln43">#include &quot;yb/common/schema.h&quot;</a>
<a name="ln44">#include &quot;yb/consensus/consensus.pb.h&quot;</a>
<a name="ln45">#include &quot;yb/gutil/map-util.h&quot;</a>
<a name="ln46">#include &quot;yb/gutil/stringprintf.h&quot;</a>
<a name="ln47">#include &quot;yb/gutil/strings/join.h&quot;</a>
<a name="ln48">#include &quot;yb/gutil/strings/numbers.h&quot;</a>
<a name="ln49">#include &quot;yb/gutil/strings/substitute.h&quot;</a>
<a name="ln50">#include &quot;yb/master/master.h&quot;</a>
<a name="ln51">#include &quot;yb/master/master.pb.h&quot;</a>
<a name="ln52">#include &quot;yb/master/master_util.h&quot;</a>
<a name="ln53">#include &quot;yb/master/sys_catalog.h&quot;</a>
<a name="ln54">#include &quot;yb/master/ts_descriptor.h&quot;</a>
<a name="ln55">#include &quot;yb/master/ts_manager.h&quot;</a>
<a name="ln56">#include &quot;yb/server/webui_util.h&quot;</a>
<a name="ln57">#include &quot;yb/util/curl_util.h&quot;</a>
<a name="ln58">#include &quot;yb/util/string_case.h&quot;</a>
<a name="ln59">#include &quot;yb/util/url-coding.h&quot;</a>
<a name="ln60">#include &quot;yb/util/version_info.h&quot;</a>
<a name="ln61">#include &quot;yb/util/version_info.pb.h&quot;</a>
<a name="ln62"> </a>
<a name="ln63">namespace yb {</a>
<a name="ln64"> </a>
<a name="ln65">namespace {</a>
<a name="ln66">static constexpr const char* kDBTypeNameUnknown = &quot;unknown&quot;;</a>
<a name="ln67">static constexpr const char* kDBTypeNameCql = &quot;ycql&quot;;</a>
<a name="ln68">static constexpr const char* kDBTypeNamePgsql = &quot;ysql&quot;;</a>
<a name="ln69">static constexpr const char* kDBTypeNameRedis = &quot;yedis&quot;;</a>
<a name="ln70"> </a>
<a name="ln71">const int64_t kCurlTimeoutSec = 180;</a>
<a name="ln72"> </a>
<a name="ln73">const char* DatabaseTypeName(YQLDatabase db) {</a>
<a name="ln74">  switch (db) {</a>
<a name="ln75">    case YQL_DATABASE_UNKNOWN: break;</a>
<a name="ln76">    case YQL_DATABASE_CQL: return kDBTypeNameCql;</a>
<a name="ln77">    case YQL_DATABASE_PGSQL: return kDBTypeNamePgsql;</a>
<a name="ln78">    case YQL_DATABASE_REDIS: return kDBTypeNameRedis;</a>
<a name="ln79">  }</a>
<a name="ln80">  CHECK(false) &lt;&lt; &quot;Unexpected db type &quot; &lt;&lt; db;</a>
<a name="ln81">  return kDBTypeNameUnknown;</a>
<a name="ln82">}</a>
<a name="ln83"> </a>
<a name="ln84">YQLDatabase DatabaseTypeByName(const string&amp; db_type_name) {</a>
<a name="ln85">  static const std::array&lt;pair&lt;const char*, YQLDatabase&gt;, 3&gt; db_types{</a>
<a name="ln86">      make_pair(kDBTypeNameCql, YQLDatabase::YQL_DATABASE_CQL),</a>
<a name="ln87">      make_pair(kDBTypeNamePgsql, YQLDatabase::YQL_DATABASE_PGSQL),</a>
<a name="ln88">      make_pair(kDBTypeNameRedis, YQLDatabase::YQL_DATABASE_REDIS)};</a>
<a name="ln89">  for (const auto&amp; db : db_types) {</a>
<a name="ln90">    if (db_type_name == db.first) {</a>
<a name="ln91">      return db.second;</a>
<a name="ln92">    }</a>
<a name="ln93">  }</a>
<a name="ln94">  return YQLDatabase::YQL_DATABASE_UNKNOWN;</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">} // namespace</a>
<a name="ln98"> </a>
<a name="ln99">using consensus::RaftPeerPB;</a>
<a name="ln100">using std::vector;</a>
<a name="ln101">using std::map;</a>
<a name="ln102">using std::string;</a>
<a name="ln103">using std::stringstream;</a>
<a name="ln104">using std::unique_ptr;</a>
<a name="ln105">using strings::Substitute;</a>
<a name="ln106"> </a>
<a name="ln107">using namespace std::placeholders;</a>
<a name="ln108"> </a>
<a name="ln109">namespace master {</a>
<a name="ln110"> </a>
<a name="ln111">MasterPathHandlers::~MasterPathHandlers() {</a>
<a name="ln112">}</a>
<a name="ln113"> </a>
<a name="ln114">void MasterPathHandlers::TabletCounts::operator+=(const TabletCounts&amp; other) {</a>
<a name="ln115">  user_tablet_leaders += other.user_tablet_leaders;</a>
<a name="ln116">  user_tablet_followers += other.user_tablet_followers;</a>
<a name="ln117">  system_tablet_leaders += other.system_tablet_leaders;</a>
<a name="ln118">  system_tablet_followers += other.system_tablet_followers;</a>
<a name="ln119">}</a>
<a name="ln120"> </a>
<a name="ln121">MasterPathHandlers::ZoneTabletCounts::ZoneTabletCounts(</a>
<a name="ln122">  const TabletCounts&amp; tablet_counts,</a>
<a name="ln123">  uint32_t active_tablets_count) : tablet_counts(tablet_counts),</a>
<a name="ln124">                                   active_tablets_count(active_tablets_count) {</a>
<a name="ln125">}</a>
<a name="ln126"> </a>
<a name="ln127">void MasterPathHandlers::ZoneTabletCounts::operator+=(const ZoneTabletCounts&amp; other) {</a>
<a name="ln128">  tablet_counts += other.tablet_counts;</a>
<a name="ln129">  node_count += other.node_count;</a>
<a name="ln130">  active_tablets_count += other.active_tablets_count;</a>
<a name="ln131">}</a>
<a name="ln132"> </a>
<a name="ln133">// Retrieve the specified URL response from the leader master</a>
<a name="ln134">void MasterPathHandlers::RedirectToLeader(const Webserver::WebRequest&amp; req,</a>
<a name="ln135">                                          Webserver::WebResponse* resp) {</a>
<a name="ln136">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln137">  vector&lt;ServerEntryPB&gt; masters;</a>
<a name="ln138">  Status s = master_-&gt;ListMasters(&amp;masters);</a>
<a name="ln139">  if (!s.ok()) {</a>
<a name="ln140">    s = s.CloneAndPrepend(&quot;Unable to list masters during web request handling&quot;);</a>
<a name="ln141">    LOG(WARNING) &lt;&lt; s.ToString();</a>
<a name="ln142">    *output &lt;&lt; &quot;&lt;h2&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/h2&gt;\n&quot;;</a>
<a name="ln143">    return;</a>
<a name="ln144">  }</a>
<a name="ln145"> </a>
<a name="ln146">  string redirect;</a>
<a name="ln147">  for (const ServerEntryPB&amp; master : masters) {</a>
<a name="ln148">    if (master.has_error()) {</a>
<a name="ln149">      continue;</a>
<a name="ln150">    }</a>
<a name="ln151"> </a>
<a name="ln152">    if (master.role() == consensus::RaftPeerPB::LEADER) {</a>
<a name="ln153">      // URI already starts with a /, so none is needed between $1 and $2.</a>
<a name="ln154">      if (master.registration().http_addresses().size() &gt; 0) {</a>
<a name="ln155">        redirect = Substitute(</a>
<a name="ln156">            &quot;http://$0$1$2&quot;,</a>
<a name="ln157">            HostPortPBToString(master.registration().http_addresses(0)),</a>
<a name="ln158">            req.redirect_uri,</a>
<a name="ln159">            req.query_string.empty() ? &quot;?raw&quot; : &quot;?&quot; + req.query_string + &quot;&amp;raw&quot;);</a>
<a name="ln160">      }</a>
<a name="ln161">      break;</a>
<a name="ln162">    }</a>
<a name="ln163">  }</a>
<a name="ln164"> </a>
<a name="ln165">  if (redirect.empty()) {</a>
<a name="ln166">    string error = &quot;Unable to locate leader master to redirect this request: &quot; + redirect;</a>
<a name="ln167">    LOG(WARNING) &lt;&lt; error;</a>
<a name="ln168">    *output &lt;&lt; error &lt;&lt; &quot;&lt;br&gt;&quot;;</a>
<a name="ln169">    return;</a>
<a name="ln170">  }</a>
<a name="ln171"> </a>
<a name="ln172">  EasyCurl curl;</a>
<a name="ln173">  faststring buf;</a>
<a name="ln174">  s = curl.FetchURL(redirect, &amp;buf, kCurlTimeoutSec);</a>
<a name="ln175">  if (!s.ok()) {</a>
<a name="ln176">    LOG(WARNING) &lt;&lt; &quot;Error retrieving leader master URL: &quot; &lt;&lt; redirect</a>
<a name="ln177">                 &lt;&lt; &quot;, error :&quot; &lt;&lt; s.ToString();</a>
<a name="ln178">    *output &lt;&lt; &quot;Error retrieving leader master URL: &lt;a href=\&quot;&quot; &lt;&lt; redirect</a>
<a name="ln179">            &lt;&lt; &quot;\&quot;&gt;&quot; + redirect + &quot;&lt;/a&gt;&lt;br&gt; Error: &quot; &lt;&lt; s.ToString() &lt;&lt; &quot;.&lt;br&gt;&quot;;</a>
<a name="ln180">    return;</a>
<a name="ln181">  }</a>
<a name="ln182"> </a>
<a name="ln183">  *output &lt;&lt; buf.ToString();</a>
<a name="ln184">}</a>
<a name="ln185"> </a>
<a name="ln186">void MasterPathHandlers::CallIfLeaderOrPrintRedirect(</a>
<a name="ln187">    const Webserver::WebRequest&amp; req, Webserver::WebResponse* resp,</a>
<a name="ln188">    const Webserver::PathHandlerCallback&amp; callback) {</a>
<a name="ln189">  string redirect;</a>
<a name="ln190">  // Lock the CatalogManager in a self-contained block, to prevent double-locking on callbacks.</a>
<a name="ln191">  {</a>
<a name="ln192">    CatalogManager::ScopedLeaderSharedLock l(master_-&gt;catalog_manager());</a>
<a name="ln193"> </a>
<a name="ln194">    // If we are not the master leader, redirect the URL.</a>
<a name="ln195">    if (!l.first_failed_status().ok()) {</a>
<a name="ln196">      RedirectToLeader(req, resp);</a>
<a name="ln197">      return;</a>
<a name="ln198">    }</a>
<a name="ln199"> </a>
<a name="ln200">    // Handle the request as a leader master.</a>
<a name="ln201">    callback(req, resp);</a>
<a name="ln202">    return;</a>
<a name="ln203">  }</a>
<a name="ln204">}</a>
<a name="ln205"> </a>
<a name="ln206">inline void MasterPathHandlers::TServerTable(std::stringstream* output) {</a>
<a name="ln207">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln208">  *output &lt;&lt; &quot;    &lt;tr&gt;\n&quot;</a>
<a name="ln209">          &lt;&lt; &quot;      &lt;th&gt;Server&lt;/th&gt;\n&quot;</a>
<a name="ln210">          &lt;&lt; &quot;      &lt;th&gt;Time since &lt;/br&gt;heartbeat&lt;/th&gt;\n&quot;</a>
<a name="ln211">          &lt;&lt; &quot;      &lt;th&gt;Status &amp; Uptime&lt;/th&gt;\n&quot;</a>
<a name="ln212">          &lt;&lt; &quot;      &lt;th&gt;User Tablet-Peers / Leaders&lt;/th&gt;\n&quot;</a>
<a name="ln213">          &lt;&lt; &quot;      &lt;th&gt;RAM Used&lt;/th&gt;\n&quot;</a>
<a name="ln214">          &lt;&lt; &quot;      &lt;th&gt;Num SST Files&lt;/th&gt;\n&quot;</a>
<a name="ln215">          &lt;&lt; &quot;      &lt;th&gt;Total SST Files Size&lt;/th&gt;\n&quot;</a>
<a name="ln216">          &lt;&lt; &quot;      &lt;th&gt;Uncompressed SST &lt;/br&gt;Files Size&lt;/th&gt;\n&quot;</a>
<a name="ln217">          &lt;&lt; &quot;      &lt;th&gt;Read ops/sec&lt;/th&gt;\n&quot;</a>
<a name="ln218">          &lt;&lt; &quot;      &lt;th&gt;Write ops/sec&lt;/th&gt;\n&quot;</a>
<a name="ln219">          &lt;&lt; &quot;      &lt;th&gt;Cloud&lt;/th&gt;\n&quot;</a>
<a name="ln220">          &lt;&lt; &quot;      &lt;th&gt;Region&lt;/th&gt;\n&quot;</a>
<a name="ln221">          &lt;&lt; &quot;      &lt;th&gt;Zone&lt;/th&gt;\n&quot;</a>
<a name="ln222">          &lt;&lt; &quot;      &lt;th&gt;System Tablet-Peers / Leaders&lt;/th&gt;\n&quot;</a>
<a name="ln223">          &lt;&lt; &quot;      &lt;th&gt;Active Tablet-Peers&lt;/th&gt;\n&quot;</a>
<a name="ln224">          &lt;&lt; &quot;    &lt;/tr&gt;\n&quot;;</a>
<a name="ln225">}</a>
<a name="ln226"> </a>
<a name="ln227">namespace {</a>
<a name="ln228"> </a>
<a name="ln229">constexpr int kHoursPerDay = 24;</a>
<a name="ln230">constexpr int kSecondsPerMinute = 60;</a>
<a name="ln231">constexpr int kMinutesPerHour = 60;</a>
<a name="ln232">constexpr int kSecondsPerHour = kSecondsPerMinute * kMinutesPerHour;</a>
<a name="ln233">constexpr int kMinutesPerDay = kMinutesPerHour * kHoursPerDay;</a>
<a name="ln234">constexpr int kSecondsPerDay = kSecondsPerHour * kHoursPerDay;</a>
<a name="ln235"> </a>
<a name="ln236">string UptimeString(uint64_t seconds) {</a>
<a name="ln237">  int days = seconds / kSecondsPerDay;</a>
<a name="ln238">  int hours = (seconds / kSecondsPerHour) - (days * kHoursPerDay);</a>
<a name="ln239">  int mins = (seconds / kSecondsPerMinute) - (days * kMinutesPerDay) - (hours * kMinutesPerHour);</a>
<a name="ln240"> </a>
<a name="ln241">  std::ostringstream uptime_string_stream;</a>
<a name="ln242">  uptime_string_stream &lt;&lt; &quot; &quot;;</a>
<a name="ln243">  if (days &gt; 0) {</a>
<a name="ln244">    uptime_string_stream &lt;&lt; days &lt;&lt; &quot;days, &quot;;</a>
<a name="ln245">  }</a>
<a name="ln246">  uptime_string_stream &lt;&lt; hours &lt;&lt; &quot;:&quot; &lt;&lt; std::setw(2) &lt;&lt; std::setfill('0') &lt;&lt; mins &lt;&lt;</a>
<a name="ln247">      &quot;:&quot; &lt;&lt; std::setw(2) &lt;&lt; std::setfill('0') &lt;&lt; (seconds % 60);</a>
<a name="ln248"> </a>
<a name="ln249">  return uptime_string_stream.str();</a>
<a name="ln250">}</a>
<a name="ln251"> </a>
<a name="ln252">} // anonymous namespace</a>
<a name="ln253"> </a>
<a name="ln254">string MasterPathHandlers::GetHttpHostPortFromServerRegistration(</a>
<a name="ln255">    const ServerRegistrationPB&amp; reg) const {</a>
<a name="ln256">  if (reg.http_addresses().size() &gt; 0) {</a>
<a name="ln257">    return HostPortPBToString(reg.http_addresses(0));</a>
<a name="ln258">  }</a>
<a name="ln259">  return &quot;&quot;;</a>
<a name="ln260">}</a>
<a name="ln261"> </a>
<a name="ln262">void MasterPathHandlers::TServerDisplay(const std::string&amp; current_uuid,</a>
<a name="ln263">                                        std::vector&lt;std::shared_ptr&lt;TSDescriptor&gt;&gt;* descs,</a>
<a name="ln264">                                        TabletCountMap* tablet_map,</a>
<a name="ln265">                                        std::stringstream* output) {</a>
<a name="ln266">  for (auto desc : *descs) {</a>
<a name="ln267">    if (desc-&gt;placement_uuid() == current_uuid) {</a>
<a name="ln268">      const string time_since_hb = StringPrintf(&quot;%.1fs&quot;, desc-&gt;TimeSinceHeartbeat().ToSeconds());</a>
<a name="ln269">      TSRegistrationPB reg = desc-&gt;GetRegistration();</a>
<a name="ln270">      string host_port = GetHttpHostPortFromServerRegistration(reg.common());</a>
<a name="ln271">      *output &lt;&lt; &quot;  &lt;tr&gt;\n&quot;;</a>
<a name="ln272">      *output &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; RegistrationToHtml(reg.common(), host_port) &lt;&lt; &quot;&lt;/br&gt;&quot;;</a>
<a name="ln273">      *output &lt;&lt; &quot;  &quot; &lt;&lt; desc-&gt;permanent_uuid() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln274">      *output &lt;&lt; &quot;&lt;td&gt;&quot; &lt;&lt; time_since_hb &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln275">      if (master_-&gt;ts_manager()-&gt;IsTSLive(desc)) {</a>
<a name="ln276">        *output &lt;&lt; &quot;    &lt;td style=\&quot;color:Green\&quot;&gt;&quot; &lt;&lt; kTserverAlive &lt;&lt; &quot;:&quot; &lt;&lt;</a>
<a name="ln277">                UptimeString(desc-&gt;uptime_seconds()) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln278">      } else {</a>
<a name="ln279">        *output &lt;&lt; &quot;    &lt;td style=\&quot;color:Red\&quot;&gt;&quot; &lt;&lt; kTserverDead &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln280">      }</a>
<a name="ln281"> </a>
<a name="ln282">      auto tserver = tablet_map-&gt;find(desc-&gt;permanent_uuid());</a>
<a name="ln283">      bool no_tablets = tserver == tablet_map-&gt;end();</a>
<a name="ln284">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; (no_tablets ? 0</a>
<a name="ln285">              : tserver-&gt;second.user_tablet_leaders + tserver-&gt;second.user_tablet_followers)</a>
<a name="ln286">              &lt;&lt; &quot; / &quot; &lt;&lt; (no_tablets ? 0 : tserver-&gt;second.user_tablet_leaders) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln287">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; HumanizeBytes(desc-&gt;total_memory_usage()) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln288">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; desc-&gt;num_sst_files() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln289">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; HumanizeBytes(desc-&gt;total_sst_file_size()) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln290">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; HumanizeBytes(desc-&gt;uncompressed_sst_file_size()) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln291">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; desc-&gt;read_ops_per_sec() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln292">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; desc-&gt;write_ops_per_sec() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln293">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; reg.common().cloud_info().placement_cloud() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln294">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; reg.common().cloud_info().placement_region() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln295">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; reg.common().cloud_info().placement_zone() &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln296">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; (no_tablets ? 0</a>
<a name="ln297">              : tserver-&gt;second.system_tablet_leaders + tserver-&gt;second.system_tablet_followers)</a>
<a name="ln298">              &lt;&lt; &quot; / &quot; &lt;&lt; (no_tablets ? 0 : tserver-&gt;second.system_tablet_leaders) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln299">      *output &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; (no_tablets ? 0 : desc-&gt;num_live_replicas()) &lt;&lt; &quot;&lt;/td&gt;&quot;;</a>
<a name="ln300">      *output &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln301">    }</a>
<a name="ln302">  }</a>
<a name="ln303">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln304">}</a>
<a name="ln305"> </a>
<a name="ln306">void MasterPathHandlers::DisplayTabletZonesTable(</a>
<a name="ln307">  const ZoneTabletCounts::CloudTree&amp; cloud_tree,</a>
<a name="ln308">  std::stringstream* output</a>
<a name="ln309">) {</a>
<a name="ln310">  *output &lt;&lt; &quot;&lt;h3&gt;Tablet-Peers by Availability Zone&lt;/h3&gt;\n&quot;</a>
<a name="ln311">          &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;</a>
<a name="ln312">          &lt;&lt; &quot;  &lt;tr&gt;\n&quot;</a>
<a name="ln313">          &lt;&lt; &quot;    &lt;th&gt;Cloud&lt;/th&gt;\n&quot;</a>
<a name="ln314">          &lt;&lt; &quot;    &lt;th&gt;Region&lt;/th&gt;\n&quot;</a>
<a name="ln315">          &lt;&lt; &quot;    &lt;th&gt;Zone&lt;/th&gt;\n&quot;</a>
<a name="ln316">          &lt;&lt; &quot;    &lt;th&gt;Total Nodes&lt;/th&gt;\n&quot;</a>
<a name="ln317">          &lt;&lt; &quot;    &lt;th&gt;User Tablet-Peers / Leaders&lt;/th&gt;\n&quot;</a>
<a name="ln318">          &lt;&lt; &quot;    &lt;th&gt;System Tablet-Peers / Leaders&lt;/th&gt;\n&quot;</a>
<a name="ln319">          &lt;&lt; &quot;    &lt;th&gt;Active Tablet-Peers&lt;/th&gt;\n&quot;</a>
<a name="ln320">          &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln321"> </a>
<a name="ln322">  for (const auto&amp; cloud_iter : cloud_tree) {</a>
<a name="ln323">    const auto&amp; region_tree = cloud_iter.second;</a>
<a name="ln324">    bool needs_new_row = false;</a>
<a name="ln325"> </a>
<a name="ln326">    int total_size_rows = 0;</a>
<a name="ln327">    for (const auto&amp; region_iter : region_tree) {</a>
<a name="ln328">      total_size_rows += region_iter.second.size();</a>
<a name="ln329">    }</a>
<a name="ln330"> </a>
<a name="ln331">    *output &lt;&lt; &quot;&lt;tr&gt;\n&quot;</a>
<a name="ln332">            &lt;&lt; &quot;  &lt;td rowspan=\&quot;&quot; &lt;&lt; total_size_rows &lt;&lt;&quot;\&quot;&gt;&quot; &lt;&lt; cloud_iter.first &lt;&lt; &quot;&lt;/td&gt;\n&quot;;</a>
<a name="ln333"> </a>
<a name="ln334">    for (const auto&amp; region_iter : region_tree) {</a>
<a name="ln335">      const auto&amp; zone_tree = region_iter.second;</a>
<a name="ln336"> </a>
<a name="ln337">      if (needs_new_row) {</a>
<a name="ln338">        *output &lt;&lt; &quot;&lt;tr&gt;\n&quot;;</a>
<a name="ln339">        needs_new_row = false;</a>
<a name="ln340">      }</a>
<a name="ln341"> </a>
<a name="ln342">      *output &lt;&lt; &quot;  &lt;td rowspan=\&quot;&quot; &lt;&lt; zone_tree.size() &lt;&lt;&quot;\&quot;&gt;&quot; &lt;&lt; region_iter.first</a>
<a name="ln343">              &lt;&lt; &quot;&lt;/td&gt;\n&quot;;</a>
<a name="ln344"> </a>
<a name="ln345">      for (const auto&amp; zone_iter : zone_tree) {</a>
<a name="ln346">        const auto&amp; counts = zone_iter.second;</a>
<a name="ln347"> </a>
<a name="ln348">        if (needs_new_row) {</a>
<a name="ln349">          *output &lt;&lt; &quot;&lt;tr&gt;\n&quot;;</a>
<a name="ln350">        }</a>
<a name="ln351"> </a>
<a name="ln352">        *output &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; zone_iter.first &lt;&lt; &quot;&lt;/td&gt;\n&quot;;</a>
<a name="ln353"> </a>
<a name="ln354">        uint32_t user_leaders = counts.tablet_counts.user_tablet_leaders;</a>
<a name="ln355">        uint32_t user_total = user_leaders + counts.tablet_counts.user_tablet_followers;</a>
<a name="ln356">        uint32_t system_leaders = counts.tablet_counts.system_tablet_leaders;</a>
<a name="ln357">        uint32_t system_total = system_leaders + counts.tablet_counts.system_tablet_followers;</a>
<a name="ln358"> </a>
<a name="ln359">        *output &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; counts.node_count &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln360">                &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; user_total &lt;&lt; &quot; / &quot; &lt;&lt; user_leaders &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln361">                &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; system_total &lt;&lt; &quot; / &quot; &lt;&lt; system_leaders &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln362">                &lt;&lt; &quot;  &lt;td&gt;&quot; &lt;&lt; counts.active_tablets_count &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln363">                &lt;&lt; &quot;&lt;/tr&gt;\n&quot;;</a>
<a name="ln364"> </a>
<a name="ln365">        needs_new_row = true;</a>
<a name="ln366">      }</a>
<a name="ln367">    }</a>
<a name="ln368">  }</a>
<a name="ln369"> </a>
<a name="ln370">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln371">}</a>
<a name="ln372"> </a>
<a name="ln373">MasterPathHandlers::ZoneTabletCounts::CloudTree MasterPathHandlers::CalculateTabletCountsTree(</a>
<a name="ln374">  const std::vector&lt;std::shared_ptr&lt;TSDescriptor&gt;&gt;&amp; descriptors,</a>
<a name="ln375">  const TabletCountMap&amp; tablet_count_map</a>
<a name="ln376">) {</a>
<a name="ln377">  ZoneTabletCounts::CloudTree cloud_tree;</a>
<a name="ln378"> </a>
<a name="ln379">  for (const auto&amp; descriptor : descriptors) {</a>
<a name="ln380">    CloudInfoPB cloud_info = descriptor-&gt;GetRegistration().common().cloud_info();</a>
<a name="ln381">    std::string cloud = cloud_info.placement_cloud();</a>
<a name="ln382">    std::string region = cloud_info.placement_region();</a>
<a name="ln383">    std::string zone = cloud_info.placement_zone();</a>
<a name="ln384"> </a>
<a name="ln385">    auto tablet_count_search = tablet_count_map.find(descriptor-&gt;permanent_uuid());</a>
<a name="ln386">    ZoneTabletCounts counts = tablet_count_search == tablet_count_map.end()</a>
<a name="ln387">        ? ZoneTabletCounts()</a>
<a name="ln388">        : ZoneTabletCounts(tablet_count_search-&gt;second, descriptor-&gt;num_live_replicas());</a>
<a name="ln389"> </a>
<a name="ln390">    auto cloud_iter = cloud_tree.find(cloud);</a>
<a name="ln391">    if (cloud_iter == cloud_tree.end()) {</a>
<a name="ln392">      ZoneTabletCounts::RegionTree region_tree;</a>
<a name="ln393">      ZoneTabletCounts::ZoneTree zone_tree;</a>
<a name="ln394"> </a>
<a name="ln395">      zone_tree.emplace(zone, std::move(counts));</a>
<a name="ln396">      region_tree.emplace(region, std::move(zone_tree));</a>
<a name="ln397">      cloud_tree.emplace(cloud, std::move(region_tree));</a>
<a name="ln398">    } else {</a>
<a name="ln399">      ZoneTabletCounts::RegionTree&amp; region_tree = cloud_iter-&gt;second;</a>
<a name="ln400"> </a>
<a name="ln401">      auto region_iter = region_tree.find(region);</a>
<a name="ln402">      if (region_iter == region_tree.end()) {</a>
<a name="ln403">        ZoneTabletCounts::ZoneTree zone_tree;</a>
<a name="ln404"> </a>
<a name="ln405">        zone_tree.emplace(zone, std::move(counts));</a>
<a name="ln406">        region_tree.emplace(region, std::move(zone_tree));</a>
<a name="ln407">      } else {</a>
<a name="ln408">        ZoneTabletCounts::ZoneTree&amp; zone_tree = region_iter-&gt;second;</a>
<a name="ln409"> </a>
<a name="ln410">        auto zone_iter = zone_tree.find(zone);</a>
<a name="ln411">        if (zone_iter == zone_tree.end()) {</a>
<a name="ln412">          zone_tree.emplace(zone, std::move(counts));</a>
<a name="ln413">        } else {</a>
<a name="ln414">          zone_iter-&gt;second += counts;</a>
<a name="ln415">        }</a>
<a name="ln416">      }</a>
<a name="ln417">    }</a>
<a name="ln418">  }</a>
<a name="ln419"> </a>
<a name="ln420">  return cloud_tree;</a>
<a name="ln421">}</a>
<a name="ln422"> </a>
<a name="ln423">void MasterPathHandlers::HandleTabletServers(const Webserver::WebRequest&amp; req,</a>
<a name="ln424">                                             Webserver::WebResponse* resp) {</a>
<a name="ln425">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln426">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln427"> </a>
<a name="ln428">  SysClusterConfigEntryPB config;</a>
<a name="ln429">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln430">  if (!s.ok()) {</a>
<a name="ln431">    *output &lt;&lt; &quot;&lt;div class=\&quot;alert alert-warning\&quot;&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/div&gt;&quot;;</a>
<a name="ln432">    return;</a>
<a name="ln433">  }</a>
<a name="ln434"> </a>
<a name="ln435">  auto live_id = config.replication_info().live_replicas().placement_uuid();</a>
<a name="ln436"> </a>
<a name="ln437">  vector&lt;std::shared_ptr&lt;TSDescriptor&gt; &gt; descs;</a>
<a name="ln438">  const auto&amp; ts_manager = master_-&gt;ts_manager();</a>
<a name="ln439">  ts_manager-&gt;GetAllDescriptors(&amp;descs);</a>
<a name="ln440"> </a>
<a name="ln441">  // Get user and system tablet leader and follower counts for each TabletServer</a>
<a name="ln442">  TabletCountMap tablet_map;</a>
<a name="ln443">  CalculateTabletMap(&amp;tablet_map);</a>
<a name="ln444"> </a>
<a name="ln445">  unordered_set&lt;string&gt; read_replica_uuids;</a>
<a name="ln446">  for (auto desc : descs) {</a>
<a name="ln447">    if (!read_replica_uuids.count(desc-&gt;placement_uuid()) &amp;&amp; desc-&gt;placement_uuid() != live_id) {</a>
<a name="ln448">      read_replica_uuids.insert(desc-&gt;placement_uuid());</a>
<a name="ln449">    }</a>
<a name="ln450">  }</a>
<a name="ln451"> </a>
<a name="ln452">  *output &lt;&lt; std::setprecision(output_precision_);</a>
<a name="ln453">  *output &lt;&lt; &quot;&lt;h2&gt;Tablet Servers&lt;/h2&gt;\n&quot;;</a>
<a name="ln454"> </a>
<a name="ln455">  if (!live_id.empty()) {</a>
<a name="ln456">    *output &lt;&lt; &quot;&lt;h3 style=\&quot;color:&quot; &lt;&lt; kYBDarkBlue &lt;&lt; &quot;\&quot;&gt;Primary Cluster UUID: &quot;</a>
<a name="ln457">            &lt;&lt; live_id &lt;&lt; &quot;&lt;/h3&gt;\n&quot;;</a>
<a name="ln458">  }</a>
<a name="ln459"> </a>
<a name="ln460">  TServerTable(output);</a>
<a name="ln461">  TServerDisplay(live_id, &amp;descs, &amp;tablet_map, output);</a>
<a name="ln462"> </a>
<a name="ln463">  for (const auto&amp; read_replica_uuid : read_replica_uuids) {</a>
<a name="ln464">    *output &lt;&lt; &quot;&lt;h3 style=\&quot;color:&quot; &lt;&lt; kYBDarkBlue &lt;&lt; &quot;\&quot;&gt;Read Replica UUID: &quot;</a>
<a name="ln465">            &lt;&lt; (read_replica_uuid.empty() ? kNoPlacementUUID : read_replica_uuid) &lt;&lt; &quot;&lt;/h3&gt;\n&quot;;</a>
<a name="ln466">    TServerTable(output);</a>
<a name="ln467">    TServerDisplay(read_replica_uuid, &amp;descs, &amp;tablet_map, output);</a>
<a name="ln468">  }</a>
<a name="ln469"> </a>
<a name="ln470">  ZoneTabletCounts::CloudTree counts_tree = CalculateTabletCountsTree(descs, tablet_map);</a>
<a name="ln471">  DisplayTabletZonesTable(counts_tree, output);</a>
<a name="ln472">}</a>
<a name="ln473"> </a>
<a name="ln474">void MasterPathHandlers::HandleGetTserverStatus(const Webserver::WebRequest&amp; req,</a>
<a name="ln475">                                             Webserver::WebResponse* resp) {</a>
<a name="ln476">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln477">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln478"> </a>
<a name="ln479">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln480"> </a>
<a name="ln481">  SysClusterConfigEntryPB config;</a>
<a name="ln482">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln483">  if (!s.ok()) {</a>
<a name="ln484">    jw.StartObject();</a>
<a name="ln485">    jw.String(&quot;error&quot;);</a>
<a name="ln486">    jw.String(s.ToString());</a>
<a name="ln487">    return;</a>
<a name="ln488">  }</a>
<a name="ln489"> </a>
<a name="ln490">  vector&lt;std::shared_ptr&lt;TSDescriptor&gt; &gt; descs;</a>
<a name="ln491">  const auto&amp; ts_manager = master_-&gt;ts_manager();</a>
<a name="ln492">  ts_manager-&gt;GetAllDescriptors(&amp;descs);</a>
<a name="ln493"> </a>
<a name="ln494">  // Get user and system tablet leader and follower counts for each TabletServer.</a>
<a name="ln495">  TabletCountMap tablet_map;</a>
<a name="ln496">  CalculateTabletMap(&amp;tablet_map);</a>
<a name="ln497"> </a>
<a name="ln498">  unordered_set&lt;string&gt; cluster_uuids;</a>
<a name="ln499">  auto primary_uuid = config.replication_info().live_replicas().placement_uuid();</a>
<a name="ln500">  cluster_uuids.insert(primary_uuid);</a>
<a name="ln501">  for (auto desc : descs) {</a>
<a name="ln502">    cluster_uuids.insert(desc-&gt;placement_uuid());</a>
<a name="ln503">  }</a>
<a name="ln504"> </a>
<a name="ln505">  jw.StartObject();</a>
<a name="ln506">  for (const auto&amp; cur_uuid : cluster_uuids) {</a>
<a name="ln507">    jw.String(cur_uuid);</a>
<a name="ln508">    jw.StartObject();</a>
<a name="ln509">    for (auto desc : descs) {</a>
<a name="ln510">      if (desc-&gt;placement_uuid() == cur_uuid) {</a>
<a name="ln511">        TSRegistrationPB reg = desc-&gt;GetRegistration();</a>
<a name="ln512">        string host_port = GetHttpHostPortFromServerRegistration(reg.common());</a>
<a name="ln513">        jw.String(host_port);</a>
<a name="ln514"> </a>
<a name="ln515">        jw.StartObject();</a>
<a name="ln516"> </a>
<a name="ln517">        // Some stats may be repeated as strings due to backwards compatability.</a>
<a name="ln518">        jw.String(&quot;time_since_hb&quot;);</a>
<a name="ln519">        jw.String(StringPrintf(&quot;%.1fs&quot;, desc-&gt;TimeSinceHeartbeat().ToSeconds()));</a>
<a name="ln520">        jw.String(&quot;time_since_hb_sec&quot;);</a>
<a name="ln521">        jw.Double(desc-&gt;TimeSinceHeartbeat().ToSeconds());</a>
<a name="ln522"> </a>
<a name="ln523">        if (master_-&gt;ts_manager()-&gt;IsTSLive(desc)) {</a>
<a name="ln524">          jw.String(&quot;status&quot;);</a>
<a name="ln525">          jw.String(kTserverAlive);</a>
<a name="ln526"> </a>
<a name="ln527">          jw.String(&quot;uptime_seconds&quot;);</a>
<a name="ln528">          jw.Uint64(desc-&gt;uptime_seconds());</a>
<a name="ln529">        } else {</a>
<a name="ln530">          jw.String(&quot;status&quot;);</a>
<a name="ln531">          jw.String(kTserverDead);</a>
<a name="ln532"> </a>
<a name="ln533">          jw.String(&quot;uptime_seconds&quot;);</a>
<a name="ln534">          jw.Uint(0);</a>
<a name="ln535">        }</a>
<a name="ln536"> </a>
<a name="ln537">        jw.String(&quot;ram_used&quot;);</a>
<a name="ln538">        jw.String(HumanizeBytes(desc-&gt;total_memory_usage()));</a>
<a name="ln539">        jw.String(&quot;ram_used_bytes&quot;);</a>
<a name="ln540">        jw.Uint64(desc-&gt;total_memory_usage());</a>
<a name="ln541"> </a>
<a name="ln542">        jw.String(&quot;num_sst_files&quot;);</a>
<a name="ln543">        jw.Uint64(desc-&gt;num_sst_files());</a>
<a name="ln544"> </a>
<a name="ln545">        jw.String(&quot;total_sst_file_size&quot;);</a>
<a name="ln546">        jw.String(HumanizeBytes(desc-&gt;total_sst_file_size()));</a>
<a name="ln547">        jw.String(&quot;total_sst_file_size_bytes&quot;);</a>
<a name="ln548">        jw.Uint64(desc-&gt;total_sst_file_size());</a>
<a name="ln549"> </a>
<a name="ln550">        jw.String(&quot;uncompressed_sst_file_size&quot;);</a>
<a name="ln551">        jw.String(HumanizeBytes(desc-&gt;uncompressed_sst_file_size()));</a>
<a name="ln552">        jw.String(&quot;uncompressed_sst_file_size_bytes&quot;);</a>
<a name="ln553">        jw.Uint64(desc-&gt;uncompressed_sst_file_size());</a>
<a name="ln554"> </a>
<a name="ln555">        jw.String(&quot;read_ops_per_sec&quot;);</a>
<a name="ln556">        jw.Double(desc-&gt;read_ops_per_sec());</a>
<a name="ln557"> </a>
<a name="ln558">        jw.String(&quot;write_ops_per_sec&quot;);</a>
<a name="ln559">        jw.Double(desc-&gt;write_ops_per_sec());</a>
<a name="ln560"> </a>
<a name="ln561">        auto tserver = tablet_map.find(desc-&gt;permanent_uuid());</a>
<a name="ln562">        uint user_tablets_total = 0;</a>
<a name="ln563">        uint user_tablets_leaders = 0;</a>
<a name="ln564">        uint system_tablets_total = 0;</a>
<a name="ln565">        uint system_tablets_leaders = 0;</a>
<a name="ln566">        int active_tablets = 0;</a>
<a name="ln567">        if (!(tserver == tablet_map.end())) {</a>
<a name="ln568">          user_tablets_total = tserver-&gt;second.user_tablet_leaders +</a>
<a name="ln569">            tserver-&gt;second.user_tablet_followers;</a>
<a name="ln570">          user_tablets_leaders = tserver-&gt;second.user_tablet_leaders;</a>
<a name="ln571">          system_tablets_total = tserver-&gt;second.system_tablet_leaders +</a>
<a name="ln572">            tserver-&gt;second.system_tablet_followers;</a>
<a name="ln573">          system_tablets_leaders = tserver-&gt;second.system_tablet_leaders;</a>
<a name="ln574">          active_tablets = desc-&gt;num_live_replicas();</a>
<a name="ln575">        }</a>
<a name="ln576">        jw.String(&quot;user_tablets_total&quot;);</a>
<a name="ln577">        jw.Uint(user_tablets_total);</a>
<a name="ln578"> </a>
<a name="ln579">        jw.String(&quot;user_tablets_leaders&quot;);</a>
<a name="ln580">        jw.Uint(user_tablets_leaders);</a>
<a name="ln581"> </a>
<a name="ln582">        jw.String(&quot;system_tablets_total&quot;);</a>
<a name="ln583">        jw.Uint(system_tablets_total);</a>
<a name="ln584"> </a>
<a name="ln585">        jw.String(&quot;system_tablets_leaders&quot;);</a>
<a name="ln586">        jw.Uint(system_tablets_leaders);</a>
<a name="ln587"> </a>
<a name="ln588">        jw.String(&quot;active_tablets&quot;);</a>
<a name="ln589">        jw.Int(active_tablets);</a>
<a name="ln590"> </a>
<a name="ln591">        jw.EndObject();</a>
<a name="ln592">      }</a>
<a name="ln593">    }</a>
<a name="ln594">    jw.EndObject();</a>
<a name="ln595">  }</a>
<a name="ln596">  jw.EndObject();</a>
<a name="ln597">}</a>
<a name="ln598"> </a>
<a name="ln599">void MasterPathHandlers::HandleHealthCheck(</a>
<a name="ln600">    const Webserver::WebRequest&amp; req, Webserver::WebResponse* resp) {</a>
<a name="ln601">  // TODO: Lock not needed since other APIs handle it.  Refactor other functions accordingly</a>
<a name="ln602">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln603">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln604"> </a>
<a name="ln605">  SysClusterConfigEntryPB config;</a>
<a name="ln606">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln607">  if (!s.ok()) {</a>
<a name="ln608">    jw.StartObject();</a>
<a name="ln609">    jw.String(&quot;error&quot;);</a>
<a name="ln610">    jw.String(s.ToString());</a>
<a name="ln611">    return;</a>
<a name="ln612">  }</a>
<a name="ln613">  int replication_factor;</a>
<a name="ln614">  s = master_-&gt;catalog_manager()-&gt;GetReplicationFactor(&amp;replication_factor);</a>
<a name="ln615">  if (!s.ok()) {</a>
<a name="ln616">    jw.StartObject();</a>
<a name="ln617">    jw.String(&quot;error&quot;);</a>
<a name="ln618">    jw.String(s.ToString());</a>
<a name="ln619">    return;</a>
<a name="ln620">  }</a>
<a name="ln621"> </a>
<a name="ln622">  vector&lt;std::shared_ptr&lt;TSDescriptor&gt; &gt; descs;</a>
<a name="ln623">  const auto* ts_manager = master_-&gt;ts_manager();</a>
<a name="ln624">  ts_manager-&gt;GetAllDescriptors(&amp;descs);</a>
<a name="ln625"> </a>
<a name="ln626">  const auto&amp; live_placement_uuid = config.replication_info().live_replicas().placement_uuid();</a>
<a name="ln627">  // Ignore read replica health for V1.</a>
<a name="ln628"> </a>
<a name="ln629">  vector&lt;std::shared_ptr&lt;TSDescriptor&gt; &gt; dead_nodes;</a>
<a name="ln630">  uint64_t most_recent_uptime = std::numeric_limits&lt;uint64_t&gt;::max();</a>
<a name="ln631"> </a>
<a name="ln632">  jw.StartObject();</a>
<a name="ln633">  {</a>
<a name="ln634">    // Iterate TabletServers, looking for health anomalies.</a>
<a name="ln635">    for (const auto &amp; desc : descs) {</a>
<a name="ln636">      if (desc-&gt;placement_uuid() == live_placement_uuid) {</a>
<a name="ln637">        if (!master_-&gt;ts_manager()-&gt;IsTSLive(desc)) {</a>
<a name="ln638">          // 1. Are any of the TS marked dead in the master?</a>
<a name="ln639">          dead_nodes.push_back(desc);</a>
<a name="ln640">        } else {</a>
<a name="ln641">          // 2. Have any of the servers restarted lately?</a>
<a name="ln642">          most_recent_uptime = min(most_recent_uptime, desc-&gt;uptime_seconds());</a>
<a name="ln643">        }</a>
<a name="ln644">      }</a>
<a name="ln645">    }</a>
<a name="ln646"> </a>
<a name="ln647">    jw.String(&quot;dead_nodes&quot;);</a>
<a name="ln648">    jw.StartArray();</a>
<a name="ln649">    for (auto const &amp; ts_desc : dead_nodes) {</a>
<a name="ln650">      jw.String(ts_desc-&gt;permanent_uuid());</a>
<a name="ln651">    }</a>
<a name="ln652">    jw.EndArray();</a>
<a name="ln653"> </a>
<a name="ln654">    jw.String(&quot;most_recent_uptime&quot;);</a>
<a name="ln655">    jw.Uint(most_recent_uptime);</a>
<a name="ln656"> </a>
<a name="ln657">    auto time_arg = req.parsed_args.find(&quot;tserver_death_interval_msecs&quot;);</a>
<a name="ln658">    int64 death_interval_msecs = 0;</a>
<a name="ln659">    if (time_arg != req.parsed_args.end()) {</a>
<a name="ln660">      death_interval_msecs = atoi(time_arg-&gt;second.c_str());</a>
<a name="ln661">    }</a>
<a name="ln662"> </a>
<a name="ln663">    // Get all the tablets and add the tablet id for each tablet that has</a>
<a name="ln664">    // replication locations lesser than 'replication_factor'.</a>
<a name="ln665">    jw.String(&quot;under_replicated_tablets&quot;);</a>
<a name="ln666">    jw.StartArray();</a>
<a name="ln667"> </a>
<a name="ln668">    vector&lt;scoped_refptr&lt;TableInfo&gt;&gt; tables;</a>
<a name="ln669">    master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables, true /* include only running tables */);</a>
<a name="ln670">    for (const auto&amp; table : tables) {</a>
<a name="ln671">      // Ignore tables that are neither user tables nor user indexes.</a>
<a name="ln672">      // However there are a bunch of system tables that still need to be investigated:</a>
<a name="ln673">      // 1. Redis system table.</a>
<a name="ln674">      // 2. Transaction status table.</a>
<a name="ln675">      // 3. Metrics table.</a>
<a name="ln676">      if (!master_-&gt;catalog_manager()-&gt;IsUserTable(*table) &amp;&amp;</a>
<a name="ln677">          table-&gt;GetTableType() != REDIS_TABLE_TYPE &amp;&amp;</a>
<a name="ln678">          table-&gt;GetTableType() != TRANSACTION_STATUS_TABLE_TYPE &amp;&amp;</a>
<a name="ln679">          !(table-&gt;namespace_id() == kSystemNamespaceId &amp;&amp;</a>
<a name="ln680">            table-&gt;name() == kMetricsSnapshotsTableName)) {</a>
<a name="ln681">        continue;</a>
<a name="ln682">      }</a>
<a name="ln683"> </a>
<a name="ln684">      TabletInfos tablets;</a>
<a name="ln685">      table-&gt;GetAllTablets(&amp;tablets);</a>
<a name="ln686"> </a>
<a name="ln687">      for (const auto&amp; tablet : tablets) {</a>
<a name="ln688">        TabletInfo::ReplicaMap replication_locations;</a>
<a name="ln689">        tablet-&gt;GetReplicaLocations(&amp;replication_locations);</a>
<a name="ln690"> </a>
<a name="ln691">        if (replication_locations.size() &lt; replication_factor) {</a>
<a name="ln692">          // These tablets don't have the required replication locations needed.</a>
<a name="ln693">          jw.String(tablet-&gt;tablet_id());</a>
<a name="ln694">          continue;</a>
<a name="ln695">        }</a>
<a name="ln696"> </a>
<a name="ln697">        // Check if we have tablets that have replicas on the dead node.</a>
<a name="ln698">        if (dead_nodes.size() == 0) {</a>
<a name="ln699">          continue;</a>
<a name="ln700">        }</a>
<a name="ln701">        int recent_replica_count = 0;</a>
<a name="ln702">        for (const auto&amp; iter : replication_locations) {</a>
<a name="ln703">          if (std::find_if(dead_nodes.begin(),</a>
<a name="ln704">                           dead_nodes.end(),</a>
<a name="ln705">                           [iter, death_interval_msecs] (const auto&amp; ts) {</a>
<a name="ln706">                               return (ts-&gt;permanent_uuid() == iter.first &amp;&amp;</a>
<a name="ln707">                                       ts-&gt;TimeSinceHeartbeat().ToMilliseconds() &gt;</a>
<a name="ln708">                                           death_interval_msecs); }) ==</a>
<a name="ln709">                  dead_nodes.end()) {</a>
<a name="ln710">            ++recent_replica_count;</a>
<a name="ln711">          }</a>
<a name="ln712">        }</a>
<a name="ln713">        if (recent_replica_count &lt; replication_factor) {</a>
<a name="ln714">          jw.String(tablet-&gt;tablet_id());</a>
<a name="ln715">        }</a>
<a name="ln716">      }</a>
<a name="ln717">    }</a>
<a name="ln718">    jw.EndArray();</a>
<a name="ln719"> </a>
<a name="ln720">    // TODO: Add these health checks in a subsequent diff</a>
<a name="ln721">    //</a>
<a name="ln722">    // 4. is the load balancer busy moving tablets/leaders around</a>
<a name="ln723">    /* Use: CHECKED_STATUS IsLoadBalancerIdle(const IsLoadBalancerIdleRequestPB* req,</a>
<a name="ln724">                                              IsLoadBalancerIdleResponsePB* resp);</a>
<a name="ln725">     */</a>
<a name="ln726">    // 5. do any of the TS have tablets they were not able to start up</a>
<a name="ln727">  }</a>
<a name="ln728">  jw.EndObject();</a>
<a name="ln729">}</a>
<a name="ln730"> </a>
<a name="ln731">string MasterPathHandlers::GetParentTableOid(scoped_refptr&lt;TableInfo&gt; parent_table) {</a>
<a name="ln732">  TableId t_id = parent_table-&gt;id();;</a>
<a name="ln733">  if (master_-&gt;catalog_manager()-&gt;IsColocatedParentTable(*parent_table)) {</a>
<a name="ln734">    // No YSQL parent id for colocated database parent table</a>
<a name="ln735">    return &quot;&quot;;</a>
<a name="ln736">  }</a>
<a name="ln737">  const auto parent_result = GetPgsqlTablegroupOidByTableId(t_id);</a>
<a name="ln738">  RETURN_NOT_OK_RET(ResultToStatus(parent_result), &quot;&quot;);</a>
<a name="ln739">  return std::to_string(*parent_result);</a>
<a name="ln740">}</a>
<a name="ln741"> </a>
<a name="ln742">void MasterPathHandlers::HandleCatalogManager(const Webserver::WebRequest&amp; req,</a>
<a name="ln743">                                              Webserver::WebResponse* resp,</a>
<a name="ln744">                                              bool only_user_tables) {</a>
<a name="ln745">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln746">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln747"> </a>
<a name="ln748">  vector&lt;scoped_refptr&lt;TableInfo&gt; &gt; tables;</a>
<a name="ln749">  master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables);</a>
<a name="ln750"> </a>
<a name="ln751">  bool has_tablegroups = master_-&gt;catalog_manager()-&gt;HasTablegroups();</a>
<a name="ln752"> </a>
<a name="ln753">  typedef map&lt;string, string&gt; StringMap;</a>
<a name="ln754"> </a>
<a name="ln755">  // The first stores user tables, the second index tables, and the third system tables.</a>
<a name="ln756">  std::unique_ptr&lt;StringMap&gt; ordered_tables[kNumTypes];</a>
<a name="ln757">  for (int i = 0; i &lt; kNumTypes; ++i) {</a>
<a name="ln758">    ordered_tables[i] = std::make_unique&lt;StringMap&gt;();</a>
<a name="ln759">  }</a>
<a name="ln760"> </a>
<a name="ln761">  TableType table_cat;</a>
<a name="ln762">  for (const scoped_refptr&lt;TableInfo&gt;&amp; table : tables) {</a>
<a name="ln763">    auto l = table-&gt;LockForRead();</a>
<a name="ln764">    if (!l-&gt;data().is_running()) {</a>
<a name="ln765">      continue;</a>
<a name="ln766">    }</a>
<a name="ln767"> </a>
<a name="ln768">    string keyspace = master_-&gt;catalog_manager()-&gt;GetNamespaceName(table-&gt;namespace_id());</a>
<a name="ln769">    bool is_platform = keyspace.compare(kSystemPlatformNamespace) == 0;</a>
<a name="ln770"> </a>
<a name="ln771">    // Determine the table category. YugaWare tables should be displayed as system tables.</a>
<a name="ln772">    if (is_platform) {</a>
<a name="ln773">      table_cat = kSystemTable;</a>
<a name="ln774">    } else if (master_-&gt;catalog_manager()-&gt;IsUserIndex(*table)) {</a>
<a name="ln775">      table_cat = kUserIndex;</a>
<a name="ln776">    } else if (master_-&gt;catalog_manager()-&gt;IsUserTable(*table)) {</a>
<a name="ln777">      table_cat = kUserTable;</a>
<a name="ln778">    } else if (master_-&gt;catalog_manager()-&gt;IsTablegroupParentTable(*table) ||</a>
<a name="ln779">               master_-&gt;catalog_manager()-&gt;IsColocatedParentTable(*table)) {</a>
<a name="ln780">      table_cat = kColocatedParentTable;</a>
<a name="ln781">    } else {</a>
<a name="ln782">      table_cat = kSystemTable;</a>
<a name="ln783">    }</a>
<a name="ln784">    // Skip non-user tables if we should.</a>
<a name="ln785">    if (only_user_tables &amp;&amp; (table_cat != kUserIndex &amp;&amp; table_cat != kUserTable)) {</a>
<a name="ln786">      continue;</a>
<a name="ln787">    }</a>
<a name="ln788"> </a>
<a name="ln789">    string table_uuid = table-&gt;id();</a>
<a name="ln790">    string state = SysTablesEntryPB_State_Name(l-&gt;data().pb.state());</a>
<a name="ln791">    Capitalize(&amp;state);</a>
<a name="ln792">    string ysql_table_oid;</a>
<a name="ln793">    string ysql_parent_oid;</a>
<a name="ln794"> </a>
<a name="ln795">    string display_info = Substitute(</a>
<a name="ln796">                          &quot;&lt;tr&gt;&quot; \</a>
<a name="ln797">                          &quot;&lt;td&gt;$0&lt;/td&gt;&quot;,</a>
<a name="ln798">                          EscapeForHtmlToString(keyspace));</a>
<a name="ln799"> </a>
<a name="ln800">    if (table-&gt;GetTableType() == PGSQL_TABLE_TYPE &amp;&amp;</a>
<a name="ln801">        !master_-&gt;catalog_manager()-&gt;IsColocatedParentTable(*table) &amp;&amp;</a>
<a name="ln802">        !master_-&gt;catalog_manager()-&gt;IsTablegroupParentTable(*table)) {</a>
<a name="ln803">      const auto result = GetPgsqlTableOid(table_uuid);</a>
<a name="ln804">      if (result.ok()) {</a>
<a name="ln805">        ysql_table_oid = std::to_string(*result);</a>
<a name="ln806">      } else {</a>
<a name="ln807">        LOG(ERROR) &lt;&lt; &quot;Failed to get OID of '&quot; &lt;&lt; table_uuid &lt;&lt; &quot;' ysql table&quot;;</a>
<a name="ln808">      }</a>
<a name="ln809"> </a>
<a name="ln810">      display_info += Substitute(</a>
<a name="ln811">                      &quot;&lt;td&gt;&lt;a href=\&quot;/table?id=$3\&quot;&gt;$0&lt;/a&gt;&lt;/td&gt;&quot; \</a>
<a name="ln812">                      &quot;&lt;td&gt;$1&lt;/td&gt;&quot; \</a>
<a name="ln813">                      &quot;&lt;td&gt;$2&lt;/td&gt;&quot; \</a>
<a name="ln814">                      &quot;&lt;td&gt;$3&lt;/td&gt;&quot; \</a>
<a name="ln815">                      &quot;&lt;td&gt;$4&lt;/td&gt;&quot;,</a>
<a name="ln816">                      EscapeForHtmlToString(l-&gt;data().name()),</a>
<a name="ln817">                      state,</a>
<a name="ln818">                      EscapeForHtmlToString(l-&gt;data().pb.state_msg()),</a>
<a name="ln819">                      EscapeForHtmlToString(table_uuid),</a>
<a name="ln820">                      ysql_table_oid);</a>
<a name="ln821"> </a>
<a name="ln822">      if (has_tablegroups) {</a>
<a name="ln823">        if (master_-&gt;catalog_manager()-&gt;IsColocatedUserTable(*table)) {</a>
<a name="ln824">          const auto parent_table = table-&gt;GetColocatedTablet()-&gt;table();</a>
<a name="ln825">          ysql_parent_oid = GetParentTableOid(parent_table);</a>
<a name="ln826">          display_info += Substitute(&quot;&lt;td&gt;$0&lt;/td&gt;&quot;, ysql_parent_oid);</a>
<a name="ln827">        } else {</a>
<a name="ln828">          display_info += Substitute(&quot;&lt;td&gt;&lt;/td&gt;&quot;);</a>
<a name="ln829">        }</a>
<a name="ln830">      }</a>
<a name="ln831">    } else if (master_-&gt;catalog_manager()-&gt;IsTablegroupParentTable(*table) ||</a>
<a name="ln832">               master_-&gt;catalog_manager()-&gt;IsColocatedParentTable(*table)) {</a>
<a name="ln833">      // Colocated parent table.</a>
<a name="ln834">      ysql_table_oid = GetParentTableOid(table);</a>
<a name="ln835"> </a>
<a name="ln836">      // Insert a newline in id and name to wrap long tablegroup text.</a>
<a name="ln837">      std::string parent_name = l-&gt;data().name();</a>
<a name="ln838">      display_info += Substitute(</a>
<a name="ln839">                      &quot;&lt;td&gt;&lt;a href=\&quot;/table?id=$0\&quot;&gt;$1&lt;/a&gt;&lt;/td&gt;&quot; \</a>
<a name="ln840">                      &quot;&lt;td&gt;$2&lt;/td&gt;&quot; \</a>
<a name="ln841">                      &quot;&lt;td&gt;$3&lt;/td&gt;&quot; \</a>
<a name="ln842">                      &quot;&lt;td&gt;$4&lt;/td&gt;&quot; \</a>
<a name="ln843">                      &quot;&lt;td&gt;$5&lt;/td&gt;&quot;,</a>
<a name="ln844">                      EscapeForHtmlToString(table_uuid),</a>
<a name="ln845">                      EscapeForHtmlToString(parent_name.insert(32, &quot;\n&quot;)),</a>
<a name="ln846">                      state,</a>
<a name="ln847">                      EscapeForHtmlToString(l-&gt;data().pb.state_msg()),</a>
<a name="ln848">                      EscapeForHtmlToString(table_uuid.insert(32, &quot;\n&quot;)),</a>
<a name="ln849">                      ysql_table_oid);</a>
<a name="ln850">    } else {</a>
<a name="ln851">      // System table - don't include parent table column</a>
<a name="ln852">      display_info += Substitute(</a>
<a name="ln853">                      &quot;&lt;td&gt;&lt;a href=\&quot;/table?id=$3\&quot;&gt;$0&lt;/a&gt;&lt;/td&gt;&quot; \</a>
<a name="ln854">                      &quot;&lt;td&gt;$1&lt;/td&gt;&quot; \</a>
<a name="ln855">                      &quot;&lt;td&gt;$2&lt;/td&gt;&quot; \</a>
<a name="ln856">                      &quot;&lt;td&gt;$3&lt;/td&gt;&quot; \</a>
<a name="ln857">                      &quot;&lt;td&gt;$4&lt;/td&gt;&quot;,</a>
<a name="ln858">                      EscapeForHtmlToString(l-&gt;data().name()),</a>
<a name="ln859">                      state,</a>
<a name="ln860">                      EscapeForHtmlToString(l-&gt;data().pb.state_msg()),</a>
<a name="ln861">                      EscapeForHtmlToString(table_uuid),</a>
<a name="ln862">                      ysql_table_oid);</a>
<a name="ln863">    }</a>
<a name="ln864">    display_info += &quot;&lt;/tr&gt;\n&quot;;</a>
<a name="ln865">    (*ordered_tables[table_cat])[table_uuid] = display_info;</a>
<a name="ln866">  }</a>
<a name="ln867"> </a>
<a name="ln868">  for (int i = 0; i &lt; kNumTypes; ++i) {</a>
<a name="ln869">    if (only_user_tables &amp;&amp; (table_type_[i] != &quot;Index&quot; &amp;&amp; table_type_[i] != &quot;User&quot;)) {</a>
<a name="ln870">      continue;</a>
<a name="ln871">    }</a>
<a name="ln872">    if (ordered_tables[i]-&gt;empty() &amp;&amp; table_type_[i] == &quot;Colocated&quot;) {</a>
<a name="ln873">      continue;</a>
<a name="ln874">    }</a>
<a name="ln875"> </a>
<a name="ln876">    (*output) &lt;&lt; &quot;&lt;div class='panel panel-default'&gt;\n&quot;</a>
<a name="ln877">              &lt;&lt; &quot;&lt;div class='panel-heading'&gt;&lt;h2 class='panel-title'&gt;&quot; &lt;&lt; table_type_[i]</a>
<a name="ln878">              &lt;&lt; &quot; tables&lt;/h2&gt;&lt;/div&gt;\n&quot;;</a>
<a name="ln879">    (*output) &lt;&lt; &quot;&lt;div class='panel-body table-responsive'&gt;&quot;;</a>
<a name="ln880"> </a>
<a name="ln881">    if (ordered_tables[i]-&gt;empty()) {</a>
<a name="ln882">      (*output) &lt;&lt; &quot;There are no &quot; &lt;&lt; static_cast&lt;char&gt;(tolower(table_type_[i][0]))</a>
<a name="ln883">                &lt;&lt; table_type_[i].substr(1) &lt;&lt; &quot; tables.\n&quot;;</a>
<a name="ln884">    } else {</a>
<a name="ln885">      *output &lt;&lt; &quot;&lt;table class='table table-striped' style='table-layout: fixed;'&gt;\n&quot;;</a>
<a name="ln886">      *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th width='14%'&gt;Keyspace&lt;/th&gt;\n&quot;</a>
<a name="ln887">              &lt;&lt; &quot;      &lt;th width='21%'&gt;Table Name&lt;/th&gt;\n&quot;</a>
<a name="ln888">              &lt;&lt; &quot;      &lt;th width='9%'&gt;State&lt;/th&gt;\n&quot;</a>
<a name="ln889">              &lt;&lt; &quot;      &lt;th width='14%'&gt;Message&lt;/th&gt;\n&quot;;</a>
<a name="ln890">      if ((table_type_[i] == &quot;User&quot; || table_type_[i] == &quot;Index&quot;) &amp;&amp; has_tablegroups) {</a>
<a name="ln891">        *output &lt;&lt; &quot;      &lt;th width='22%'&gt;UUID&lt;/th&gt;\n&quot;</a>
<a name="ln892">                &lt;&lt; &quot;      &lt;th width='10%'&gt;YSQL OID&lt;/th&gt;\n&quot;</a>
<a name="ln893">                &lt;&lt; &quot;      &lt;th width='10%'&gt;Parent OID&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln894">      } else {</a>
<a name="ln895">        *output &lt;&lt; &quot;      &lt;th width='28%'&gt;UUID&lt;/th&gt;\n&quot;</a>
<a name="ln896">                &lt;&lt; &quot;      &lt;th width='14%'&gt;YSQL OID&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln897">      }</a>
<a name="ln898">      for (const StringMap::value_type &amp;table : *(ordered_tables[i])) {</a>
<a name="ln899">        *output &lt;&lt; table.second;</a>
<a name="ln900">      }</a>
<a name="ln901">      (*output) &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln902">    }</a>
<a name="ln903">    (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel-body --&gt;\n&quot;;</a>
<a name="ln904">    (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel --&gt;\n&quot;;</a>
<a name="ln905">  }</a>
<a name="ln906">}</a>
<a name="ln907"> </a>
<a name="ln908">namespace {</a>
<a name="ln909"> </a>
<a name="ln910">bool CompareByRole(const TabletReplica&amp; a, const TabletReplica&amp; b) {</a>
<a name="ln911">  return a.role &lt; b.role;</a>
<a name="ln912">}</a>
<a name="ln913"> </a>
<a name="ln914">} // anonymous namespace</a>
<a name="ln915"> </a>
<a name="ln916"> </a>
<a name="ln917">void MasterPathHandlers::HandleTablePage(const Webserver::WebRequest&amp; req,</a>
<a name="ln918">                                         Webserver::WebResponse* resp) {</a>
<a name="ln919">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln920">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln921"> </a>
<a name="ln922">  // True if table_id, false if (keyspace, table).</a>
<a name="ln923">  const auto arg_end = req.parsed_args.end();</a>
<a name="ln924">  auto id_arg = req.parsed_args.find(&quot;id&quot;);</a>
<a name="ln925">  auto keyspace_arg = arg_end;</a>
<a name="ln926">  auto table_arg = arg_end;</a>
<a name="ln927">  if (id_arg == arg_end) {</a>
<a name="ln928">    keyspace_arg = req.parsed_args.find(&quot;keyspace_name&quot;);</a>
<a name="ln929">    table_arg = req.parsed_args.find(&quot;table_name&quot;);</a>
<a name="ln930">    if (keyspace_arg == arg_end || table_arg == arg_end) {</a>
<a name="ln931">      *output &lt;&lt; &quot; Missing 'id' argument or 'keyspace_name, table_name' argument pair.&quot;;</a>
<a name="ln932">      *output &lt;&lt; &quot; Arguments must either contain the table id or the &quot;</a>
<a name="ln933">                 &quot; (keyspace_name, table_name) pair.&quot;;</a>
<a name="ln934">      return;</a>
<a name="ln935">    }</a>
<a name="ln936">  }</a>
<a name="ln937"> </a>
<a name="ln938">  scoped_refptr&lt;TableInfo&gt; table;</a>
<a name="ln939"> </a>
<a name="ln940">  if (id_arg != arg_end) {</a>
<a name="ln941">    table = master_-&gt;catalog_manager()-&gt;GetTableInfo(id_arg-&gt;second);</a>
<a name="ln942">  } else {</a>
<a name="ln943">    const auto keyspace_type_arg = req.parsed_args.find(&quot;keyspace_type&quot;);</a>
<a name="ln944">    const auto keyspace_type = (keyspace_type_arg == arg_end</a>
<a name="ln945">        ? GetDefaultDatabaseType(keyspace_arg-&gt;second)</a>
<a name="ln946">        : DatabaseTypeByName(keyspace_type_arg-&gt;second));</a>
<a name="ln947">    if (keyspace_type == YQLDatabase::YQL_DATABASE_UNKNOWN) {</a>
<a name="ln948">      *output &lt;&lt; &quot;Wrong keyspace_type found '&quot; &lt;&lt; keyspace_type_arg-&gt;second &lt;&lt; &quot;'.&quot;</a>
<a name="ln949">              &lt;&lt; &quot;Possible values are: &quot; &lt;&lt; kDBTypeNameCql &lt;&lt; &quot;, &quot;</a>
<a name="ln950">              &lt;&lt; kDBTypeNamePgsql &lt;&lt; &quot;, &quot; &lt;&lt; kDBTypeNameRedis &lt;&lt; &quot;.&quot;;</a>
<a name="ln951">      return;</a>
<a name="ln952">    }</a>
<a name="ln953">    table = master_-&gt;catalog_manager()-&gt;GetTableInfoFromNamespaceNameAndTableName(</a>
<a name="ln954">        keyspace_type, keyspace_arg-&gt;second, table_arg-&gt;second);</a>
<a name="ln955">  }</a>
<a name="ln956"> </a>
<a name="ln957">  if (table == nullptr) {</a>
<a name="ln958">    *output &lt;&lt; &quot;Table not found!&quot;;</a>
<a name="ln959">    return;</a>
<a name="ln960">  }</a>
<a name="ln961"> </a>
<a name="ln962">  Schema schema;</a>
<a name="ln963">  PartitionSchema partition_schema;</a>
<a name="ln964">  NamespaceName keyspace_name;</a>
<a name="ln965">  TableName table_name;</a>
<a name="ln966">  vector&lt;scoped_refptr&lt;TabletInfo&gt; &gt; tablets;</a>
<a name="ln967">  {</a>
<a name="ln968">    auto l = table-&gt;LockForRead();</a>
<a name="ln969">    keyspace_name = master_-&gt;catalog_manager()-&gt;GetNamespaceName(table-&gt;namespace_id());</a>
<a name="ln970">    table_name = l-&gt;data().name();</a>
<a name="ln971">    *output &lt;&lt; &quot;&lt;h1&gt;Table: &quot; &lt;&lt; EscapeForHtmlToString(TableLongName(keyspace_name, table_name))</a>
<a name="ln972">            &lt;&lt; &quot; (&quot;&lt;&lt; table-&gt;id() &lt;&lt;&quot;) &lt;/h1&gt;\n&quot;;</a>
<a name="ln973"> </a>
<a name="ln974">    *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln975">    *output &lt;&lt; &quot;  &lt;tr&gt;&lt;td&gt;Version:&lt;/td&gt;&lt;td&gt;&quot; &lt;&lt; l-&gt;data().pb.version() &lt;&lt; &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln976"> </a>
<a name="ln977">    *output &lt;&lt; &quot;  &lt;tr&gt;&lt;td&gt;Type:&lt;/td&gt;&lt;td&gt;&quot; &lt;&lt; TableType_Name(l-&gt;data().pb.table_type())</a>
<a name="ln978">            &lt;&lt; &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln979"> </a>
<a name="ln980">    string state = SysTablesEntryPB_State_Name(l-&gt;data().pb.state());</a>
<a name="ln981">    Capitalize(&amp;state);</a>
<a name="ln982">    *output &lt;&lt; &quot;  &lt;tr&gt;&lt;td&gt;State:&lt;/td&gt;&lt;td&gt;&quot;</a>
<a name="ln983">            &lt;&lt; state</a>
<a name="ln984">            &lt;&lt; EscapeForHtmlToString(l-&gt;data().pb.state_msg())</a>
<a name="ln985">            &lt;&lt; &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln986">    *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln987"> </a>
<a name="ln988">    Status s = SchemaFromPB(l-&gt;data().pb.schema(), &amp;schema);</a>
<a name="ln989">    if (s.ok()) {</a>
<a name="ln990">      s = PartitionSchema::FromPB(l-&gt;data().pb.partition_schema(), schema, &amp;partition_schema);</a>
<a name="ln991">    }</a>
<a name="ln992">    if (!s.ok()) {</a>
<a name="ln993">      *output &lt;&lt; &quot;Unable to decode partition schema: &quot; &lt;&lt; s.ToString();</a>
<a name="ln994">      return;</a>
<a name="ln995">    }</a>
<a name="ln996">    table-&gt;GetAllTablets(&amp;tablets);</a>
<a name="ln997">  }</a>
<a name="ln998"> </a>
<a name="ln999">  HtmlOutputSchemaTable(schema, output);</a>
<a name="ln1000"> </a>
<a name="ln1001">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln1002">  *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th&gt;Tablet ID&lt;/th&gt;&lt;th&gt;Partition&lt;/th&gt;&lt;th&gt;State&lt;/th&gt;&quot;</a>
<a name="ln1003">      &quot;&lt;th&gt;Message&lt;/th&gt;&lt;th&gt;RaftConfig&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln1004">  for (const scoped_refptr&lt;TabletInfo&gt;&amp; tablet : tablets) {</a>
<a name="ln1005">    TabletInfo::ReplicaMap locations;</a>
<a name="ln1006">    tablet-&gt;GetReplicaLocations(&amp;locations);</a>
<a name="ln1007">    vector&lt;TabletReplica&gt; sorted_locations;</a>
<a name="ln1008">    AppendValuesFromMap(locations, &amp;sorted_locations);</a>
<a name="ln1009">    std::sort(sorted_locations.begin(), sorted_locations.end(), &amp;CompareByRole);</a>
<a name="ln1010"> </a>
<a name="ln1011">    auto l = tablet-&gt;LockForRead();</a>
<a name="ln1012"> </a>
<a name="ln1013">    Partition partition;</a>
<a name="ln1014">    Partition::FromPB(l-&gt;data().pb.partition(), &amp;partition);</a>
<a name="ln1015"> </a>
<a name="ln1016">    string state = SysTabletsEntryPB_State_Name(l-&gt;data().pb.state());</a>
<a name="ln1017">    Capitalize(&amp;state);</a>
<a name="ln1018">    *output &lt;&lt; Substitute(</a>
<a name="ln1019">        &quot;&lt;tr&gt;&lt;th&gt;$0&lt;/th&gt;&lt;td&gt;$1&lt;/td&gt;&lt;td&gt;$2&lt;/td&gt;&lt;td&gt;$3&lt;/td&gt;&lt;td&gt;$4&lt;/td&gt;&lt;/tr&gt;\n&quot;,</a>
<a name="ln1020">        tablet-&gt;tablet_id(),</a>
<a name="ln1021">        EscapeForHtmlToString(partition_schema.PartitionDebugString(partition, schema)),</a>
<a name="ln1022">        state,</a>
<a name="ln1023">        EscapeForHtmlToString(l-&gt;data().pb.state_msg()),</a>
<a name="ln1024">        RaftConfigToHtml(sorted_locations, tablet-&gt;tablet_id()));</a>
<a name="ln1025">  }</a>
<a name="ln1026">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln1027"> </a>
<a name="ln1028">  HtmlOutputTasks(table-&gt;GetTasks(), output);</a>
<a name="ln1029">}</a>
<a name="ln1030"> </a>
<a name="ln1031">void MasterPathHandlers::HandleTasksPage(const Webserver::WebRequest&amp; req,</a>
<a name="ln1032">                                         Webserver::WebResponse* resp) {</a>
<a name="ln1033">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1034">  vector&lt;scoped_refptr&lt;TableInfo&gt; &gt; tables;</a>
<a name="ln1035">  master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables);</a>
<a name="ln1036">  *output &lt;&lt; &quot;&lt;h3&gt;Active Tasks&lt;/h3&gt;\n&quot;;</a>
<a name="ln1037">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln1038">  *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th&gt;Task Name&lt;/th&gt;&lt;th&gt;State&lt;/th&gt;&lt;th&gt;Start &quot;</a>
<a name="ln1039">             &quot;Time&lt;/th&gt;&lt;th&gt;Time&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln1040">  for (const auto&amp; table : tables) {</a>
<a name="ln1041">    for (const auto&amp; task : table-&gt;GetTasks()) {</a>
<a name="ln1042">      HtmlOutputTask(task, output);</a>
<a name="ln1043">    }</a>
<a name="ln1044">  }</a>
<a name="ln1045">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln1046"> </a>
<a name="ln1047">  std::vector&lt;std::shared_ptr&lt;MonitoredTask&gt;&gt; jobs =</a>
<a name="ln1048">      master_-&gt;catalog_manager()-&gt;GetRecentJobs();</a>
<a name="ln1049">  *output &lt;&lt; Substitute(</a>
<a name="ln1050">      &quot;&lt;h3&gt;Last $0 user-initiated jobs started in the past $1 &quot;</a>
<a name="ln1051">      &quot;hours&lt;/h3&gt;\n&quot;,</a>
<a name="ln1052">      FLAGS_tasks_tracker_num_long_term_tasks,</a>
<a name="ln1053">      FLAGS_long_term_tasks_tracker_keep_time_multiplier *</a>
<a name="ln1054">          MonoDelta::FromMilliseconds(FLAGS_catalog_manager_bg_task_wait_ms)</a>
<a name="ln1055">              .ToSeconds() /</a>
<a name="ln1056">          3600);</a>
<a name="ln1057">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln1058">  *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th&gt;Job Name&lt;/th&gt;&lt;th&gt;State&lt;/th&gt;&lt;th&gt;Start &quot;</a>
<a name="ln1059">             &quot;Time&lt;/th&gt;&lt;th&gt;Duration&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln1060">  for (std::vector&lt;std::shared_ptr&lt;MonitoredTask&gt;&gt;::reverse_iterator iter =</a>
<a name="ln1061">           jobs.rbegin();</a>
<a name="ln1062">       iter != jobs.rend(); ++iter) {</a>
<a name="ln1063">    HtmlOutputTask(*iter, output);</a>
<a name="ln1064">  }</a>
<a name="ln1065">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln1066"> </a>
<a name="ln1067">  std::vector&lt;std::shared_ptr&lt;MonitoredTask&gt; &gt; tasks =</a>
<a name="ln1068">    master_-&gt;catalog_manager()-&gt;GetRecentTasks();</a>
<a name="ln1069">  *output &lt;&lt; Substitute(</a>
<a name="ln1070">      &quot;&lt;h3&gt;Last $0 tasks started in the past $1 seconds&lt;/h3&gt;\n&quot;,</a>
<a name="ln1071">      FLAGS_tasks_tracker_num_tasks,</a>
<a name="ln1072">      FLAGS_tasks_tracker_keep_time_multiplier *</a>
<a name="ln1073">          MonoDelta::FromMilliseconds(FLAGS_catalog_manager_bg_task_wait_ms)</a>
<a name="ln1074">              .ToSeconds());</a>
<a name="ln1075">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln1076">  *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th&gt;Task Name&lt;/th&gt;&lt;th&gt;State&lt;/th&gt;&lt;th&gt;Start &quot;</a>
<a name="ln1077">             &quot;Time&lt;/th&gt;&lt;th&gt;Duration&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln1078">  for (std::vector&lt;std::shared_ptr&lt;MonitoredTask&gt;&gt;::reverse_iterator iter =</a>
<a name="ln1079">           tasks.rbegin();</a>
<a name="ln1080">       iter != tasks.rend(); ++iter) {</a>
<a name="ln1081">    HtmlOutputTask(*iter, output);</a>
<a name="ln1082">  }</a>
<a name="ln1083">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln1084">}</a>
<a name="ln1085"> </a>
<a name="ln1086">void MasterPathHandlers::GetLeaderlessTablets(TabletInfos* leaderless_tablets) {</a>
<a name="ln1087">  leaderless_tablets-&gt;clear();</a>
<a name="ln1088"> </a>
<a name="ln1089">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln1090"> </a>
<a name="ln1091">  vector&lt;scoped_refptr&lt;TableInfo&gt;&gt; tables;</a>
<a name="ln1092">  master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables, /* includeOnlyRunningTables */ true);</a>
<a name="ln1093"> </a>
<a name="ln1094">  for (const auto&amp; table : tables) {</a>
<a name="ln1095">    if (master_-&gt;catalog_manager()-&gt;IsSystemTable(*table.get())) {</a>
<a name="ln1096">      continue;</a>
<a name="ln1097">    }</a>
<a name="ln1098">    TabletInfos ts;</a>
<a name="ln1099">    table-&gt;GetAllTablets(&amp;ts);</a>
<a name="ln1100"> </a>
<a name="ln1101">    for (TabletInfoPtr t : ts) {</a>
<a name="ln1102">      TabletInfo::ReplicaMap rm;</a>
<a name="ln1103">      t.get()-&gt;GetReplicaLocations(&amp;rm);</a>
<a name="ln1104"> </a>
<a name="ln1105">      auto has_leader = std::any_of(</a>
<a name="ln1106">        rm.begin(), rm.end(),</a>
<a name="ln1107">        [](const auto &amp;item) { return item.second.role == consensus::RaftPeerPB::LEADER; });</a>
<a name="ln1108"> </a>
<a name="ln1109">      if (!has_leader) {</a>
<a name="ln1110">        leaderless_tablets-&gt;push_back(t);</a>
<a name="ln1111">      }</a>
<a name="ln1112">    }</a>
<a name="ln1113">  }</a>
<a name="ln1114">}</a>
<a name="ln1115"> </a>
<a name="ln1116">void MasterPathHandlers::HandleTabletReplicasPage(const Webserver::WebRequest&amp; req,</a>
<a name="ln1117">                                                  Webserver::WebResponse* resp) {</a>
<a name="ln1118">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1119">  TabletInfos ts;</a>
<a name="ln1120">  GetLeaderlessTablets(&amp;ts);</a>
<a name="ln1121"> </a>
<a name="ln1122">  *output &lt;&lt; &quot;&lt;h3&gt;Leaderless Tablets&lt;/h3&gt;\n&quot;;</a>
<a name="ln1123">  *output &lt;&lt; &quot;&lt;table class='table table-striped'&gt;\n&quot;;</a>
<a name="ln1124">  *output &lt;&lt; &quot;  &lt;tr&gt;&lt;th&gt;Table Name&lt;/th&gt;&lt;th&gt;Table UUID&lt;/th&gt;&lt;th&gt;Tablet ID&lt;/th&gt;&lt;/tr&gt;\n&quot;;</a>
<a name="ln1125"> </a>
<a name="ln1126">  for (TabletInfoPtr t : ts) {</a>
<a name="ln1127">    *output &lt;&lt; Substitute(</a>
<a name="ln1128">        &quot;&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;/table?id=$0\&quot;&gt;$1&lt;/a&gt;&lt;/td&gt;&lt;td&gt;$2&lt;/td&gt;&lt;th&gt;$3&lt;/th&gt;&lt;/tr&gt;\n&quot;,</a>
<a name="ln1129">        EscapeForHtmlToString(t-&gt;table()-&gt;id()),</a>
<a name="ln1130">        EscapeForHtmlToString(t-&gt;table()-&gt;name()),</a>
<a name="ln1131">        EscapeForHtmlToString(t-&gt;table()-&gt;id()),</a>
<a name="ln1132">        EscapeForHtmlToString(t.get()-&gt;tablet_id()));</a>
<a name="ln1133">  }</a>
<a name="ln1134"> </a>
<a name="ln1135">  *output &lt;&lt; &quot;&lt;/table&gt;\n&quot;;</a>
<a name="ln1136">}</a>
<a name="ln1137"> </a>
<a name="ln1138">void MasterPathHandlers::HandleGetReplicationStatus(const Webserver::WebRequest&amp; req,</a>
<a name="ln1139">                                                    Webserver::WebResponse* resp) {</a>
<a name="ln1140">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1141">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln1142"> </a>
<a name="ln1143">  TabletInfos ts;</a>
<a name="ln1144">  GetLeaderlessTablets(&amp;ts);</a>
<a name="ln1145"> </a>
<a name="ln1146">  jw.StartObject();</a>
<a name="ln1147">  jw.String(&quot;leaderless_tablets&quot;);</a>
<a name="ln1148">  jw.StartArray();</a>
<a name="ln1149"> </a>
<a name="ln1150">  for (TabletInfoPtr t : ts) {</a>
<a name="ln1151">    jw.StartObject();</a>
<a name="ln1152">    jw.String(&quot;table_uuid&quot;);</a>
<a name="ln1153">    jw.String(t-&gt;table()-&gt;id());</a>
<a name="ln1154">    jw.String(&quot;tablet_uuid&quot;);</a>
<a name="ln1155">    jw.String(t.get()-&gt;tablet_id());</a>
<a name="ln1156">    jw.EndObject();</a>
<a name="ln1157">  }</a>
<a name="ln1158"> </a>
<a name="ln1159">  jw.EndArray();</a>
<a name="ln1160">  jw.EndObject();</a>
<a name="ln1161">}</a>
<a name="ln1162"> </a>
<a name="ln1163">void MasterPathHandlers::RootHandler(const Webserver::WebRequest&amp; req,</a>
<a name="ln1164">                                     Webserver::WebResponse* resp) {</a>
<a name="ln1165">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1166">  // First check if we are the master leader. If not, make a curl call to the master leader and</a>
<a name="ln1167">  // return that as the UI payload.</a>
<a name="ln1168">  CatalogManager::ScopedLeaderSharedLock l(master_-&gt;catalog_manager());</a>
<a name="ln1169">  if (!l.first_failed_status().ok()) {</a>
<a name="ln1170">    // We are not the leader master, retrieve the response from the leader master.</a>
<a name="ln1171">    RedirectToLeader(req, resp);</a>
<a name="ln1172">    return;</a>
<a name="ln1173">  }</a>
<a name="ln1174"> </a>
<a name="ln1175">  SysClusterConfigEntryPB config;</a>
<a name="ln1176">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln1177">  if (!s.ok()) {</a>
<a name="ln1178">    *output &lt;&lt; &quot;&lt;div class=\&quot;alert alert-warning\&quot;&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/div&gt;&quot;;</a>
<a name="ln1179">    return;</a>
<a name="ln1180">  }</a>
<a name="ln1181"> </a>
<a name="ln1182">  // Get all the tables.</a>
<a name="ln1183">  vector&lt;scoped_refptr&lt;TableInfo&gt; &gt; tables;</a>
<a name="ln1184">  master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables, true /* includeOnlyRunningTables */);</a>
<a name="ln1185"> </a>
<a name="ln1186">  // Get the list of user tables.</a>
<a name="ln1187">  vector&lt;scoped_refptr&lt;TableInfo&gt; &gt; user_tables;</a>
<a name="ln1188">  for (scoped_refptr&lt;TableInfo&gt; table : tables) {</a>
<a name="ln1189">    if (master_-&gt;catalog_manager()-&gt;IsUserTable(*table)) {</a>
<a name="ln1190">      user_tables.push_back(table);</a>
<a name="ln1191">    }</a>
<a name="ln1192">  }</a>
<a name="ln1193">  // Get the version info.</a>
<a name="ln1194">  VersionInfoPB version_info;</a>
<a name="ln1195">  VersionInfo::GetVersionInfoPB(&amp;version_info);</a>
<a name="ln1196"> </a>
<a name="ln1197">  // Display the overview information.</a>
<a name="ln1198">  (*output) &lt;&lt; &quot;&lt;h1&gt;YugabyteDB&lt;/h1&gt;\n&quot;;</a>
<a name="ln1199"> </a>
<a name="ln1200">  (*output) &lt;&lt; &quot;&lt;div class='row dashboard-content'&gt;\n&quot;;</a>
<a name="ln1201"> </a>
<a name="ln1202">  (*output) &lt;&lt; &quot;&lt;div class='col-xs-12 col-md-8 col-lg-6'&gt;\n&quot;;</a>
<a name="ln1203">  (*output) &lt;&lt; &quot;&lt;div class='panel panel-default'&gt;\n&quot;</a>
<a name="ln1204">            &lt;&lt; &quot;&lt;div class='panel-heading'&gt;&lt;h2 class='panel-title'&gt; Overview&lt;/h2&gt;&lt;/div&gt;\n&quot;;</a>
<a name="ln1205">  (*output) &lt;&lt; &quot;&lt;div class='panel-body table-responsive'&gt;&quot;;</a>
<a name="ln1206">  (*output) &lt;&lt; &quot;&lt;table class='table'&gt;\n&quot;;</a>
<a name="ln1207"> </a>
<a name="ln1208">  // Universe UUID.</a>
<a name="ln1209">  (*output) &lt;&lt; &quot;  &lt;tr&gt;&quot;;</a>
<a name="ln1210">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1211">                          &quot;&lt;i class='fa fa-database yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1212">                          &quot;Universe UUID &quot;);</a>
<a name="ln1213">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0&lt;/td&gt;&quot;,</a>
<a name="ln1214">                          config.cluster_uuid());</a>
<a name="ln1215">  (*output) &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1216"> </a>
<a name="ln1217">  // Replication factor.</a>
<a name="ln1218">  (*output) &lt;&lt; &quot;  &lt;tr&gt;&quot;;</a>
<a name="ln1219">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1220">                          &quot;&lt;i class='fa fa-files-o yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1221">                          &quot;Replication Factor &quot;);</a>
<a name="ln1222">  int num_replicas = 0;</a>
<a name="ln1223">  s = master_-&gt;catalog_manager()-&gt;GetReplicationFactor(&amp;num_replicas);</a>
<a name="ln1224">  if (!s.ok()) {</a>
<a name="ln1225">    s = s.CloneAndPrepend(&quot;Unable to determine Replication factor.&quot;);</a>
<a name="ln1226">    LOG(WARNING) &lt;&lt; s.ToString();</a>
<a name="ln1227">    *output &lt;&lt; &quot;&lt;h1&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/h1&gt;\n&quot;;</a>
<a name="ln1228">  }</a>
<a name="ln1229">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0 &lt;a href='$1' class='btn btn-default pull-right'&gt;$2&lt;/a&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1230">                          num_replicas,</a>
<a name="ln1231">                          &quot;/cluster-config&quot;,</a>
<a name="ln1232">                          &quot;See full config &amp;raquo;&quot;);</a>
<a name="ln1233">  (*output) &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1234"> </a>
<a name="ln1235">  // Tserver count.</a>
<a name="ln1236">  (*output) &lt;&lt; &quot;  &lt;tr&gt;&quot;;</a>
<a name="ln1237">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1238">                          &quot;&lt;i class='fa fa-server yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1239">                          &quot;Num Nodes (TServers) &quot;);</a>
<a name="ln1240">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0 &lt;a href='$1' class='btn btn-default pull-right'&gt;$2&lt;/a&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1241">                          master_-&gt;ts_manager()-&gt;GetCount(),</a>
<a name="ln1242">                          &quot;/tablet-servers&quot;,</a>
<a name="ln1243">                          &quot;See all nodes &amp;raquo;&quot;);</a>
<a name="ln1244">  (*output) &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1245"> </a>
<a name="ln1246">  // Num user tables.</a>
<a name="ln1247">  (*output) &lt;&lt; &quot;  &lt;tr&gt;&quot;;</a>
<a name="ln1248">  (*output) &lt;&lt; Substitute(&quot; &lt;tr&gt;&lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1249">                          &quot;&lt;i class='fa fa-table yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1250">                          &quot;Num User Tables &quot;);</a>
<a name="ln1251">  (*output) &lt;&lt; Substitute(&quot; &lt;td&gt;$0 &lt;a href='$1' class='btn btn-default pull-right'&gt;$2&lt;/a&gt;&lt;/td&gt;&quot;,</a>
<a name="ln1252">                          user_tables.size(),</a>
<a name="ln1253">                          &quot;/tables&quot;,</a>
<a name="ln1254">                          &quot;See all tables &amp;raquo;&quot;);</a>
<a name="ln1255">  (*output) &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1256"> </a>
<a name="ln1257">  // Load Balancer State</a>
<a name="ln1258">  {</a>
<a name="ln1259">    IsLoadBalancerIdleRequestPB req;</a>
<a name="ln1260">    IsLoadBalancerIdleResponsePB resp;</a>
<a name="ln1261">    Status isIdle = master_-&gt;catalog_manager()-&gt;IsLoadBalancerIdle(&amp;req, &amp;resp);</a>
<a name="ln1262"> </a>
<a name="ln1263">    (*output) &lt;&lt; Substitute(&quot; &lt;tr&gt;&lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&quot;</a>
<a name="ln1264">                            &quot;&lt;td&gt;&lt;i class='fa $2' aria-hidden='true'&gt; &lt;/i&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;,</a>
<a name="ln1265">                            &quot;&lt;i class='fa fa-tasks yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1266">                            &quot;Is Load Balanced?&quot;,</a>
<a name="ln1267">                            isIdle.ok() ? &quot;fa-check&quot;</a>
<a name="ln1268">                                        : &quot;fa-times label label-danger&quot;);</a>
<a name="ln1269">  }</a>
<a name="ln1270">  // Build version and type.</a>
<a name="ln1271">  (*output) &lt;&lt; Substitute(&quot;  &lt;tr&gt;&lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&lt;td&gt;$2&lt;/td&gt;&lt;/tr&gt;\n&quot;,</a>
<a name="ln1272">                          &quot;&lt;i class='fa fa-code-fork yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1273">                          &quot;YugabyteDB Version &quot;, version_info.version_number());</a>
<a name="ln1274">  (*output) &lt;&lt; Substitute(&quot;  &lt;tr&gt;&lt;td&gt;$0&lt;span class='yb-overview'&gt;$1&lt;/span&gt;&lt;/td&gt;&lt;td&gt;$2&lt;/td&gt;&lt;/tr&gt;\n&quot;,</a>
<a name="ln1275">                          &quot;&lt;i class='fa fa-terminal yb-dashboard-icon' aria-hidden='true'&gt;&lt;/i&gt;&quot;,</a>
<a name="ln1276">                          &quot;Build Type &quot;, version_info.build_type());</a>
<a name="ln1277">  (*output) &lt;&lt; &quot;&lt;/table&gt;&quot;;</a>
<a name="ln1278">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel-body --&gt;\n&quot;;</a>
<a name="ln1279">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel --&gt;\n&quot;;</a>
<a name="ln1280">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- col-xs-12 col-md-8 col-lg-6 --&gt;\n&quot;;</a>
<a name="ln1281"> </a>
<a name="ln1282">  // Display the master info.</a>
<a name="ln1283">  (*output) &lt;&lt; &quot;&lt;div class='col-xs-12 col-md-8 col-lg-6'&gt;\n&quot;;</a>
<a name="ln1284">  HandleMasters(req, resp);</a>
<a name="ln1285">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- col-xs-12 col-md-8 col-lg-6 --&gt;\n&quot;;</a>
<a name="ln1286"> </a>
<a name="ln1287">  // Display the user tables if any.</a>
<a name="ln1288">  (*output) &lt;&lt; &quot;&lt;div class='col-md-12 col-lg-12'&gt;\n&quot;;</a>
<a name="ln1289">  HandleCatalogManager(req, resp, true /* only_user_tables */);</a>
<a name="ln1290">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- col-md-12 col-lg-12 --&gt;\n&quot;;</a>
<a name="ln1291">}</a>
<a name="ln1292"> </a>
<a name="ln1293">void MasterPathHandlers::HandleMasters(const Webserver::WebRequest&amp; req,</a>
<a name="ln1294">                                       Webserver::WebResponse* resp) {</a>
<a name="ln1295">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1296">  vector&lt;ServerEntryPB&gt; masters;</a>
<a name="ln1297">  Status s = master_-&gt;ListMasters(&amp;masters);</a>
<a name="ln1298">  if (!s.ok()) {</a>
<a name="ln1299">    s = s.CloneAndPrepend(&quot;Unable to list Masters&quot;);</a>
<a name="ln1300">    LOG(WARNING) &lt;&lt; s.ToString();</a>
<a name="ln1301">    *output &lt;&lt; &quot;&lt;h1&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/h1&gt;\n&quot;;</a>
<a name="ln1302">    return;</a>
<a name="ln1303">  }</a>
<a name="ln1304">  (*output) &lt;&lt; &quot;&lt;div class='panel panel-default'&gt;\n&quot;</a>
<a name="ln1305">            &lt;&lt; &quot;&lt;div class='panel-heading'&gt;&lt;h2 class='panel-title'&gt;Masters&lt;/h2&gt;&lt;/div&gt;\n&quot;;</a>
<a name="ln1306">  (*output) &lt;&lt; &quot;&lt;div class='panel-body table-responsive'&gt;&quot;;</a>
<a name="ln1307">  (*output) &lt;&lt; &quot;&lt;table class='table'&gt;\n&quot;;</a>
<a name="ln1308">  (*output) &lt;&lt; &quot;  &lt;tr&gt;\n&quot;</a>
<a name="ln1309">            &lt;&lt; &quot;    &lt;th&gt;Server&lt;/th&gt;\n&quot;</a>
<a name="ln1310">            &lt;&lt; &quot;    &lt;th&gt;RAFT Role&lt;/th&gt;&quot;</a>
<a name="ln1311">            &lt;&lt; &quot;    &lt;th&gt;Details&lt;/th&gt;\n&quot;</a>
<a name="ln1312">            &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1313"> </a>
<a name="ln1314">  for (const ServerEntryPB&amp; master : masters) {</a>
<a name="ln1315">    if (master.has_error()) {</a>
<a name="ln1316">      string error = StatusFromPB(master.error()).ToString();</a>
<a name="ln1317">      *output &lt;&lt; &quot;  &lt;tr&gt;\n&quot;;</a>
<a name="ln1318">      const string kErrStart = &quot;peer ([&quot;;</a>
<a name="ln1319">      const string kErrEnd = &quot;])&quot;;</a>
<a name="ln1320">      size_t start_pos = error.find(kErrStart);</a>
<a name="ln1321">      size_t end_pos = error.find(kErrEnd);</a>
<a name="ln1322">      if (start_pos != string::npos &amp;&amp; end_pos != string::npos &amp;&amp; (start_pos &lt; end_pos)) {</a>
<a name="ln1323">        start_pos = start_pos + kErrStart.length();</a>
<a name="ln1324">        string host_port = error.substr(start_pos, end_pos - start_pos);</a>
<a name="ln1325">        *output &lt;&lt; &quot;&lt;td&gt;&lt;font color='red'&gt;&quot; &lt;&lt; EscapeForHtmlToString(host_port)</a>
<a name="ln1326">                &lt;&lt; &quot;&lt;/font&gt;&lt;/td&gt;\n&quot;;</a>
<a name="ln1327">        *output &lt;&lt; &quot;&lt;td&gt;&lt;font color='red'&gt;&quot; &lt;&lt; RaftPeerPB_Role_Name(RaftPeerPB::UNKNOWN_ROLE)</a>
<a name="ln1328">                &lt;&lt; &quot;&lt;/font&gt;&lt;/td&gt;\n&quot;;</a>
<a name="ln1329">      }</a>
<a name="ln1330">      *output &lt;&lt; Substitute(&quot;    &lt;td colspan=2&gt;&lt;font color='red'&gt;&lt;b&gt;ERROR: $0&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;\n&quot;,</a>
<a name="ln1331">                              EscapeForHtmlToString(error));</a>
<a name="ln1332">      *output &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1333">      continue;</a>
<a name="ln1334">    }</a>
<a name="ln1335">    auto reg = master.registration();</a>
<a name="ln1336">    string host_port = GetHttpHostPortFromServerRegistration(reg);</a>
<a name="ln1337">    string reg_text = RegistrationToHtml(reg, host_port);</a>
<a name="ln1338">    if (master.instance_id().permanent_uuid() == master_-&gt;instance_pb().permanent_uuid()) {</a>
<a name="ln1339">      reg_text = Substitute(&quot;&lt;b&gt;$0&lt;/b&gt;&quot;, reg_text);</a>
<a name="ln1340">    }</a>
<a name="ln1341">    string raft_role = master.has_role() ? RaftPeerPB_Role_Name(master.role()) : &quot;N/A&quot;;</a>
<a name="ln1342">    string cloud = reg.cloud_info().placement_cloud();</a>
<a name="ln1343">    string region = reg.cloud_info().placement_region();</a>
<a name="ln1344">    string zone = reg.cloud_info().placement_zone();</a>
<a name="ln1345"> </a>
<a name="ln1346">    *output &lt;&lt; &quot;  &lt;tr&gt;\n&quot;</a>
<a name="ln1347">            &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; reg_text &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln1348">            &lt;&lt; &quot;    &lt;td&gt;&quot; &lt;&lt; raft_role &lt;&lt; &quot;&lt;/td&gt;\n&quot;</a>
<a name="ln1349">            &lt;&lt; &quot;    &lt;td&gt;&lt;div&gt;&lt;span class='yb-overview'&gt;CLOUD: &lt;/span&gt;&quot; &lt;&lt; cloud &lt;&lt; &quot;&lt;/div&gt;\n&quot;</a>
<a name="ln1350">            &lt;&lt; &quot;        &lt;div&gt;&lt;span class='yb-overview'&gt;REGION: &lt;/span&gt;&quot; &lt;&lt; region &lt;&lt; &quot;&lt;/div&gt;\n&quot;</a>
<a name="ln1351">            &lt;&lt; &quot;        &lt;div&gt;&lt;span class='yb-overview'&gt;ZONE: &lt;/span&gt;&quot; &lt;&lt; zone &lt;&lt; &quot;&lt;/div&gt;\n&quot;</a>
<a name="ln1352">            &lt;&lt; &quot;        &lt;div&gt;&lt;span class='yb-overview'&gt;UUID: &lt;/span&gt;&quot;</a>
<a name="ln1353">            &lt;&lt; master.instance_id().permanent_uuid()</a>
<a name="ln1354">            &lt;&lt; &quot;&lt;/div&gt;&lt;/td&gt;\n&quot;</a>
<a name="ln1355">            &lt;&lt; &quot;  &lt;/tr&gt;\n&quot;;</a>
<a name="ln1356">  }</a>
<a name="ln1357"> </a>
<a name="ln1358">  (*output) &lt;&lt; &quot;&lt;/table&gt;&quot;;</a>
<a name="ln1359">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel-body --&gt;\n&quot;;</a>
<a name="ln1360">  (*output) &lt;&lt; &quot;&lt;/div&gt; &lt;!-- panel --&gt;\n&quot;;</a>
<a name="ln1361">}</a>
<a name="ln1362"> </a>
<a name="ln1363">namespace {</a>
<a name="ln1364"> </a>
<a name="ln1365">// Visitor for the catalog table which dumps tables and tablets in a JSON format. This</a>
<a name="ln1366">// dump is interpreted by the CM agent in order to track time series entities in the SMON</a>
<a name="ln1367">// database.</a>
<a name="ln1368">//</a>
<a name="ln1369">// This implementation relies on scanning the catalog table directly instead of using the</a>
<a name="ln1370">// catalog manager APIs. This allows it to work even on a non-leader master, and avoids</a>
<a name="ln1371">// any requirement for locking. For the purposes of metrics entity gathering, it's OK to</a>
<a name="ln1372">// serve a slightly stale snapshot.</a>
<a name="ln1373">//</a>
<a name="ln1374">// It is tempting to directly dump the metadata protobufs using JsonWriter::Protobuf(...),</a>
<a name="ln1375">// but then we would be tying ourselves to textual compatibility of the PB field names in</a>
<a name="ln1376">// our catalog table. Instead, the implementation specifically dumps the fields that we</a>
<a name="ln1377">// care about.</a>
<a name="ln1378">//</a>
<a name="ln1379">// This should be considered a &quot;stable&quot; protocol -- do not rename, remove, or restructure</a>
<a name="ln1380">// without consulting with the CM team.</a>
<a name="ln1381">class JsonDumperBase {</a>
<a name="ln1382"> public:</a>
<a name="ln1383">  explicit JsonDumperBase(JsonWriter* jw) : jw_(jw) {}</a>
<a name="ln1384"> </a>
<a name="ln1385">  virtual ~JsonDumperBase() {}</a>
<a name="ln1386"> </a>
<a name="ln1387">  virtual std::string name() const = 0;</a>
<a name="ln1388"> </a>
<a name="ln1389"> protected:</a>
<a name="ln1390">  JsonWriter* jw_;</a>
<a name="ln1391">};</a>
<a name="ln1392"> </a>
<a name="ln1393">class JsonKeyspaceDumper : public Visitor&lt;PersistentNamespaceInfo&gt;, public JsonDumperBase {</a>
<a name="ln1394"> public:</a>
<a name="ln1395">  explicit JsonKeyspaceDumper(JsonWriter* jw) : JsonDumperBase(jw) {}</a>
<a name="ln1396"> </a>
<a name="ln1397">  std::string name() const override { return &quot;keyspaces&quot;; }</a>
<a name="ln1398"> </a>
<a name="ln1399">  virtual Status Visit(const std::string&amp; keyspace_id,</a>
<a name="ln1400">                       const SysNamespaceEntryPB&amp; metadata) override {</a>
<a name="ln1401">    jw_-&gt;StartObject();</a>
<a name="ln1402">    jw_-&gt;String(&quot;keyspace_id&quot;);</a>
<a name="ln1403">    jw_-&gt;String(keyspace_id);</a>
<a name="ln1404"> </a>
<a name="ln1405">    jw_-&gt;String(&quot;keyspace_name&quot;);</a>
<a name="ln1406">    jw_-&gt;String(metadata.name());</a>
<a name="ln1407"> </a>
<a name="ln1408">    jw_-&gt;String(&quot;keyspace_type&quot;);</a>
<a name="ln1409">    jw_-&gt;String(DatabaseTypeName((metadata.database_type())));</a>
<a name="ln1410"> </a>
<a name="ln1411">    jw_-&gt;EndObject();</a>
<a name="ln1412">    return Status::OK();</a>
<a name="ln1413">  }</a>
<a name="ln1414">};</a>
<a name="ln1415"> </a>
<a name="ln1416">class JsonTableDumper : public Visitor&lt;PersistentTableInfo&gt;, public JsonDumperBase {</a>
<a name="ln1417"> public:</a>
<a name="ln1418">  explicit JsonTableDumper(JsonWriter* jw) : JsonDumperBase(jw) {}</a>
<a name="ln1419"> </a>
<a name="ln1420">  std::string name() const override { return &quot;tables&quot;; }</a>
<a name="ln1421"> </a>
<a name="ln1422">  Status Visit(const std::string&amp; table_id, const SysTablesEntryPB&amp; metadata) override {</a>
<a name="ln1423">    if (metadata.state() != SysTablesEntryPB::RUNNING) {</a>
<a name="ln1424">      return Status::OK();</a>
<a name="ln1425">    }</a>
<a name="ln1426"> </a>
<a name="ln1427">    jw_-&gt;StartObject();</a>
<a name="ln1428">    jw_-&gt;String(&quot;table_id&quot;);</a>
<a name="ln1429">    jw_-&gt;String(table_id);</a>
<a name="ln1430"> </a>
<a name="ln1431">    jw_-&gt;String(&quot;keyspace_id&quot;);</a>
<a name="ln1432">    jw_-&gt;String(metadata.namespace_id());</a>
<a name="ln1433"> </a>
<a name="ln1434">    jw_-&gt;String(&quot;table_name&quot;);</a>
<a name="ln1435">    jw_-&gt;String(metadata.name());</a>
<a name="ln1436"> </a>
<a name="ln1437">    jw_-&gt;String(&quot;state&quot;);</a>
<a name="ln1438">    jw_-&gt;String(SysTablesEntryPB::State_Name(metadata.state()));</a>
<a name="ln1439"> </a>
<a name="ln1440">    jw_-&gt;EndObject();</a>
<a name="ln1441">    return Status::OK();</a>
<a name="ln1442">  }</a>
<a name="ln1443">};</a>
<a name="ln1444"> </a>
<a name="ln1445">class JsonTabletDumper : public Visitor&lt;PersistentTabletInfo&gt;, public JsonDumperBase {</a>
<a name="ln1446"> public:</a>
<a name="ln1447">  explicit JsonTabletDumper(JsonWriter* jw) : JsonDumperBase(jw) {}</a>
<a name="ln1448"> </a>
<a name="ln1449">  std::string name() const override { return &quot;tablets&quot;; }</a>
<a name="ln1450"> </a>
<a name="ln1451">  Status Visit(const std::string&amp; tablet_id, const SysTabletsEntryPB&amp; metadata) override {</a>
<a name="ln1452">    const std::string&amp; table_id = metadata.table_id();</a>
<a name="ln1453">    if (metadata.state() != SysTabletsEntryPB::RUNNING) {</a>
<a name="ln1454">      return Status::OK();</a>
<a name="ln1455">    }</a>
<a name="ln1456"> </a>
<a name="ln1457">    jw_-&gt;StartObject();</a>
<a name="ln1458">    jw_-&gt;String(&quot;table_id&quot;);</a>
<a name="ln1459">    jw_-&gt;String(table_id);</a>
<a name="ln1460"> </a>
<a name="ln1461">    jw_-&gt;String(&quot;tablet_id&quot;);</a>
<a name="ln1462">    jw_-&gt;String(tablet_id);</a>
<a name="ln1463"> </a>
<a name="ln1464">    jw_-&gt;String(&quot;state&quot;);</a>
<a name="ln1465">    jw_-&gt;String(SysTabletsEntryPB::State_Name(metadata.state()));</a>
<a name="ln1466"> </a>
<a name="ln1467">    // Dump replica UUIDs</a>
<a name="ln1468">    if (metadata.has_committed_consensus_state()) {</a>
<a name="ln1469">      const consensus::ConsensusStatePB&amp; cs = metadata.committed_consensus_state();</a>
<a name="ln1470">      jw_-&gt;String(&quot;replicas&quot;);</a>
<a name="ln1471">      jw_-&gt;StartArray();</a>
<a name="ln1472">      for (const RaftPeerPB&amp; peer : cs.config().peers()) {</a>
<a name="ln1473">        jw_-&gt;StartObject();</a>
<a name="ln1474">        jw_-&gt;String(&quot;type&quot;);</a>
<a name="ln1475">        jw_-&gt;String(RaftPeerPB::MemberType_Name(peer.member_type()));</a>
<a name="ln1476"> </a>
<a name="ln1477">        jw_-&gt;String(&quot;server_uuid&quot;);</a>
<a name="ln1478">        jw_-&gt;String(peer.permanent_uuid());</a>
<a name="ln1479"> </a>
<a name="ln1480">        jw_-&gt;String(&quot;addr&quot;);</a>
<a name="ln1481">        const auto&amp; host_port = peer.last_known_private_addr()[0];</a>
<a name="ln1482">        jw_-&gt;String(HostPortPBToString(host_port));</a>
<a name="ln1483"> </a>
<a name="ln1484">        jw_-&gt;EndObject();</a>
<a name="ln1485">      }</a>
<a name="ln1486">      jw_-&gt;EndArray();</a>
<a name="ln1487"> </a>
<a name="ln1488">      if (cs.has_leader_uuid()) {</a>
<a name="ln1489">        jw_-&gt;String(&quot;leader&quot;);</a>
<a name="ln1490">        jw_-&gt;String(cs.leader_uuid());</a>
<a name="ln1491">      }</a>
<a name="ln1492">    }</a>
<a name="ln1493"> </a>
<a name="ln1494">    jw_-&gt;EndObject();</a>
<a name="ln1495">    return Status::OK();</a>
<a name="ln1496">  }</a>
<a name="ln1497">};</a>
<a name="ln1498"> </a>
<a name="ln1499">template &lt;class Dumper&gt;</a>
<a name="ln1500">Status JsonDumpCollection(JsonWriter* jw, Master* master, stringstream* output) {</a>
<a name="ln1501">  unique_ptr&lt;Dumper&gt; json_dumper(new Dumper(jw));</a>
<a name="ln1502">  jw-&gt;String(json_dumper-&gt;name());</a>
<a name="ln1503">  jw-&gt;StartArray();</a>
<a name="ln1504">  const Status s = master-&gt;catalog_manager()-&gt;sys_catalog()-&gt;Visit(json_dumper.get());</a>
<a name="ln1505">  if (s.ok()) {</a>
<a name="ln1506">    // End the array only if there is no error.</a>
<a name="ln1507">    jw-&gt;EndArray();</a>
<a name="ln1508">  } else {</a>
<a name="ln1509">    // Print just an error message.</a>
<a name="ln1510">    output-&gt;str(&quot;&quot;);</a>
<a name="ln1511">    JsonWriter jw_err(output, JsonWriter::COMPACT);</a>
<a name="ln1512">    jw_err.StartObject();</a>
<a name="ln1513">    jw_err.String(&quot;error&quot;);</a>
<a name="ln1514">    jw_err.String(s.ToString());</a>
<a name="ln1515">    jw_err.EndObject();</a>
<a name="ln1516">  }</a>
<a name="ln1517">  return s;</a>
<a name="ln1518">}</a>
<a name="ln1519"> </a>
<a name="ln1520">} // anonymous namespace</a>
<a name="ln1521"> </a>
<a name="ln1522">void MasterPathHandlers::HandleDumpEntities(const Webserver::WebRequest&amp; req,</a>
<a name="ln1523">                                            Webserver::WebResponse* resp) {</a>
<a name="ln1524">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1525">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln1526"> </a>
<a name="ln1527">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln1528">  jw.StartObject();</a>
<a name="ln1529"> </a>
<a name="ln1530">  if (JsonDumpCollection&lt;JsonKeyspaceDumper&gt;(&amp;jw, master_, output).ok() &amp;&amp;</a>
<a name="ln1531">      JsonDumpCollection&lt;JsonTableDumper&gt;(&amp;jw, master_, output).ok() &amp;&amp;</a>
<a name="ln1532">      JsonDumpCollection&lt;JsonTabletDumper&gt;(&amp;jw, master_, output).ok()) {</a>
<a name="ln1533">    // End the object only if there is no error.</a>
<a name="ln1534">    jw.EndObject();</a>
<a name="ln1535">  }</a>
<a name="ln1536">}</a>
<a name="ln1537"> </a>
<a name="ln1538">void MasterPathHandlers::HandleCheckIfLeader(const Webserver::WebRequest&amp; req,</a>
<a name="ln1539">                                              Webserver::WebResponse* resp) {</a>
<a name="ln1540">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1541">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln1542">  jw.StartObject();</a>
<a name="ln1543">  {</a>
<a name="ln1544">    CatalogManager::ScopedLeaderSharedLock l(master_-&gt;catalog_manager());</a>
<a name="ln1545"> </a>
<a name="ln1546">    // If we are not the master leader.</a>
<a name="ln1547">    if (!l.first_failed_status().ok()) {</a>
<a name="ln1548">      resp-&gt;code = 503;</a>
<a name="ln1549">      return;</a>
<a name="ln1550">    }</a>
<a name="ln1551"> </a>
<a name="ln1552">    jw.String(&quot;STATUS&quot;);</a>
<a name="ln1553">    jw.String(l.leader_status().CodeAsString());</a>
<a name="ln1554">    jw.EndObject();</a>
<a name="ln1555">    return;</a>
<a name="ln1556">  }</a>
<a name="ln1557">}</a>
<a name="ln1558"> </a>
<a name="ln1559">void MasterPathHandlers::HandleGetMastersStatus(const Webserver::WebRequest&amp; req,</a>
<a name="ln1560">                                                    Webserver::WebResponse* resp) {</a>
<a name="ln1561">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1562">  vector&lt;ServerEntryPB&gt; masters;</a>
<a name="ln1563">  Status s = master_-&gt;ListMasters(&amp;masters);</a>
<a name="ln1564">  ListMastersResponsePB pb_resp;</a>
<a name="ln1565">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln1566">  if (!s.ok()) {</a>
<a name="ln1567">    jw.Protobuf(pb_resp);</a>
<a name="ln1568">    return;</a>
<a name="ln1569">  }</a>
<a name="ln1570">  for (const ServerEntryPB&amp; master : masters) {</a>
<a name="ln1571">    pb_resp.add_masters()-&gt;CopyFrom(master);</a>
<a name="ln1572">  }</a>
<a name="ln1573">  jw.Protobuf(pb_resp);</a>
<a name="ln1574">}</a>
<a name="ln1575"> </a>
<a name="ln1576">void MasterPathHandlers::HandleGetClusterConfig(</a>
<a name="ln1577">  const Webserver::WebRequest&amp; req, Webserver::WebResponse* resp) {</a>
<a name="ln1578">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1579">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln1580"> </a>
<a name="ln1581">  *output &lt;&lt; &quot;&lt;h1&gt;Current Cluster Config&lt;/h1&gt;\n&quot;;</a>
<a name="ln1582">  SysClusterConfigEntryPB config;</a>
<a name="ln1583">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln1584">  if (!s.ok()) {</a>
<a name="ln1585">    *output &lt;&lt; &quot;&lt;div class=\&quot;alert alert-warning\&quot;&gt;&quot; &lt;&lt; s.ToString() &lt;&lt; &quot;&lt;/div&gt;&quot;;</a>
<a name="ln1586">    return;</a>
<a name="ln1587">  }</a>
<a name="ln1588"> </a>
<a name="ln1589">  *output &lt;&lt; &quot;&lt;div class=\&quot;alert alert-success\&quot;&gt;Successfully got cluster config!&lt;/div&gt;&quot;</a>
<a name="ln1590">  &lt;&lt; &quot;&lt;pre class=\&quot;prettyprint\&quot;&gt;&quot; &lt;&lt; config.DebugString() &lt;&lt; &quot;&lt;/pre&gt;&quot;;</a>
<a name="ln1591">}</a>
<a name="ln1592"> </a>
<a name="ln1593">void MasterPathHandlers::HandleGetClusterConfigJSON(</a>
<a name="ln1594">  const Webserver::WebRequest&amp; req, Webserver::WebResponse* resp) {</a>
<a name="ln1595">  std::stringstream *output = &amp;resp-&gt;output;</a>
<a name="ln1596">  JsonWriter jw(output, JsonWriter::COMPACT);</a>
<a name="ln1597"> </a>
<a name="ln1598">  master_-&gt;catalog_manager()-&gt;AssertLeaderLockAcquiredForReading();</a>
<a name="ln1599"> </a>
<a name="ln1600">  SysClusterConfigEntryPB config;</a>
<a name="ln1601">  Status s = master_-&gt;catalog_manager()-&gt;GetClusterConfig(&amp;config);</a>
<a name="ln1602">  if (!s.ok()) {</a>
<a name="ln1603">    jw.StartObject();</a>
<a name="ln1604">    jw.String(&quot;error&quot;);</a>
<a name="ln1605">    jw.String(s.ToString());</a>
<a name="ln1606">    jw.EndObject();</a>
<a name="ln1607">    return;</a>
<a name="ln1608">  }</a>
<a name="ln1609"> </a>
<a name="ln1610">  // return cluster config in JSON format</a>
<a name="ln1611">  jw.Protobuf(config);</a>
<a name="ln1612">}</a>
<a name="ln1613"> </a>
<a name="ln1614">Status MasterPathHandlers::Register(Webserver* server) {</a>
<a name="ln1615">  bool is_styled = true;</a>
<a name="ln1616">  bool is_on_nav_bar = true;</a>
<a name="ln1617"> </a>
<a name="ln1618">  // The set of handlers visible on the nav bar.</a>
<a name="ln1619">  server-&gt;RegisterPathHandler(</a>
<a name="ln1620">    &quot;/&quot;, &quot;Home&quot;, std::bind(&amp;MasterPathHandlers::RootHandler, this, _1, _2), is_styled,</a>
<a name="ln1621">    is_on_nav_bar, &quot;fa fa-home&quot;);</a>
<a name="ln1622">  Webserver::PathHandlerCallback cb =</a>
<a name="ln1623">      std::bind(&amp;MasterPathHandlers::HandleTabletServers, this, _1, _2);</a>
<a name="ln1624">  server-&gt;RegisterPathHandler(</a>
<a name="ln1625">      &quot;/tablet-servers&quot;, &quot;Tablet Servers&quot;,</a>
<a name="ln1626">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), is_styled,</a>
<a name="ln1627">      is_on_nav_bar, &quot;fa fa-server&quot;);</a>
<a name="ln1628">  cb = std::bind(&amp;MasterPathHandlers::HandleCatalogManager,</a>
<a name="ln1629">      this, _1, _2, false /* only_user_tables */);</a>
<a name="ln1630">  server-&gt;RegisterPathHandler(</a>
<a name="ln1631">      &quot;/tables&quot;, &quot;Tables&quot;,</a>
<a name="ln1632">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), is_styled,</a>
<a name="ln1633">      is_on_nav_bar, &quot;fa fa-table&quot;);</a>
<a name="ln1634"> </a>
<a name="ln1635">  // The set of handlers not currently visible on the nav bar.</a>
<a name="ln1636">  cb = std::bind(&amp;MasterPathHandlers::HandleTablePage, this, _1, _2);</a>
<a name="ln1637">  server-&gt;RegisterPathHandler(</a>
<a name="ln1638">      &quot;/table&quot;, &quot;&quot;, std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb),</a>
<a name="ln1639">      is_styled, false);</a>
<a name="ln1640">  server-&gt;RegisterPathHandler(</a>
<a name="ln1641">      &quot;/masters&quot;, &quot;Masters&quot;, std::bind(&amp;MasterPathHandlers::HandleMasters, this, _1, _2), is_styled,</a>
<a name="ln1642">      false);</a>
<a name="ln1643">  cb = std::bind(&amp;MasterPathHandlers::HandleGetClusterConfig, this, _1, _2);</a>
<a name="ln1644">  server-&gt;RegisterPathHandler(</a>
<a name="ln1645">      &quot;/cluster-config&quot;, &quot;Cluster Config&quot;,</a>
<a name="ln1646">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), is_styled,</a>
<a name="ln1647">      false);</a>
<a name="ln1648">  cb = std::bind(&amp;MasterPathHandlers::HandleGetClusterConfigJSON, this, _1, _2);</a>
<a name="ln1649">  server-&gt;RegisterPathHandler(</a>
<a name="ln1650">      &quot;/api/v1/cluster-config&quot;, &quot;Cluster Config JSON&quot;,</a>
<a name="ln1651">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), false,</a>
<a name="ln1652">      false);</a>
<a name="ln1653">  cb = std::bind(&amp;MasterPathHandlers::HandleTasksPage, this, _1, _2);</a>
<a name="ln1654">  server-&gt;RegisterPathHandler(</a>
<a name="ln1655">      &quot;/tasks&quot;, &quot;Tasks&quot;,</a>
<a name="ln1656">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), is_styled,</a>
<a name="ln1657">      false);</a>
<a name="ln1658">  cb = std::bind(&amp;MasterPathHandlers::HandleTabletReplicasPage, this, _1, _2);</a>
<a name="ln1659">  server-&gt;RegisterPathHandler(</a>
<a name="ln1660">      &quot;/tablet-replication&quot;, &quot;Tablet Replication Health&quot;,</a>
<a name="ln1661">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), is_styled,</a>
<a name="ln1662">      false);</a>
<a name="ln1663"> </a>
<a name="ln1664">  // JSON Endpoints</a>
<a name="ln1665">  cb = std::bind(&amp;MasterPathHandlers::HandleGetTserverStatus, this, _1, _2);</a>
<a name="ln1666">  server-&gt;RegisterPathHandler(</a>
<a name="ln1667">      &quot;/api/v1/tablet-servers&quot;, &quot;Tserver Statuses&quot;,</a>
<a name="ln1668">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), false, false);</a>
<a name="ln1669">  cb = std::bind(&amp;MasterPathHandlers::HandleHealthCheck, this, _1, _2);</a>
<a name="ln1670">  server-&gt;RegisterPathHandler(</a>
<a name="ln1671">      &quot;/api/v1/health-check&quot;, &quot;Cluster Health Check&quot;,</a>
<a name="ln1672">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), false, false);</a>
<a name="ln1673">  cb = std::bind(&amp;MasterPathHandlers::HandleGetReplicationStatus, this, _1, _2);</a>
<a name="ln1674">  server-&gt;RegisterPathHandler(</a>
<a name="ln1675">      &quot;/api/v1/tablet-replication&quot;, &quot;Tablet Replication Health&quot;,</a>
<a name="ln1676">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), false, false);</a>
<a name="ln1677">  cb = std::bind(&amp;MasterPathHandlers::HandleDumpEntities, this, _1, _2);</a>
<a name="ln1678">  server-&gt;RegisterPathHandler(</a>
<a name="ln1679">      &quot;/dump-entities&quot;, &quot;Dump Entities&quot;,</a>
<a name="ln1680">      std::bind(&amp;MasterPathHandlers::CallIfLeaderOrPrintRedirect, this, _1, _2, cb), false, false);</a>
<a name="ln1681">  server-&gt;RegisterPathHandler(</a>
<a name="ln1682">      &quot;/api/v1/is-leader&quot;, &quot;Leader Check&quot;,</a>
<a name="ln1683">      std::bind(&amp;MasterPathHandlers::HandleCheckIfLeader, this, _1, _2), false, false);</a>
<a name="ln1684">  server-&gt;RegisterPathHandler(</a>
<a name="ln1685">      &quot;/api/v1/masters&quot;, &quot;Master Statuses&quot;,</a>
<a name="ln1686">      std::bind(&amp;MasterPathHandlers::HandleGetMastersStatus, this, _1, _2), false, false);</a>
<a name="ln1687">  return Status::OK();</a>
<a name="ln1688">}</a>
<a name="ln1689"> </a>
<a name="ln1690">string MasterPathHandlers::RaftConfigToHtml(const std::vector&lt;TabletReplica&gt;&amp; locations,</a>
<a name="ln1691">                                            const std::string&amp; tablet_id) const {</a>
<a name="ln1692">  stringstream html;</a>
<a name="ln1693"> </a>
<a name="ln1694">  html &lt;&lt; &quot;&lt;ul&gt;\n&quot;;</a>
<a name="ln1695">  for (const TabletReplica&amp; location : locations) {</a>
<a name="ln1696">    string location_html = TSDescriptorToHtml(*location.ts_desc, tablet_id);</a>
<a name="ln1697">    if (location.role == RaftPeerPB::LEADER) {</a>
<a name="ln1698">      html &lt;&lt; Substitute(&quot;  &lt;li&gt;&lt;b&gt;LEADER: $0&lt;/b&gt;&lt;/li&gt;\n&quot;, location_html);</a>
<a name="ln1699">    } else {</a>
<a name="ln1700">      html &lt;&lt; Substitute(&quot;  &lt;li&gt;$0: $1&lt;/li&gt;\n&quot;,</a>
<a name="ln1701">                         RaftPeerPB_Role_Name(location.role), location_html);</a>
<a name="ln1702">    }</a>
<a name="ln1703">  }</a>
<a name="ln1704">  html &lt;&lt; &quot;&lt;/ul&gt;\n&quot;;</a>
<a name="ln1705">  return html.str();</a>
<a name="ln1706">}</a>
<a name="ln1707"> </a>
<a name="ln1708">string MasterPathHandlers::TSDescriptorToHtml(const TSDescriptor&amp; desc,</a>
<a name="ln1709">                                              const std::string&amp; tablet_id) const {</a>
<a name="ln1710">  TSRegistrationPB reg = desc.GetRegistration();</a>
<a name="ln1711"> </a>
<a name="ln1712">  if (reg.common().http_addresses().size() &gt; 0) {</a>
<a name="ln1713">    return Substitute(</a>
<a name="ln1714">        &quot;&lt;a href=\&quot;http://$0/tablet?id=$1\&quot;&gt;$2&lt;/a&gt;&quot;,</a>
<a name="ln1715">        HostPortPBToString(reg.common().http_addresses(0)),</a>
<a name="ln1716">        EscapeForHtmlToString(tablet_id),</a>
<a name="ln1717">        EscapeForHtmlToString(reg.common().http_addresses(0).host()));</a>
<a name="ln1718">  } else {</a>
<a name="ln1719">    return EscapeForHtmlToString(desc.permanent_uuid());</a>
<a name="ln1720">  }</a>
<a name="ln1721">}</a>
<a name="ln1722"> </a>
<a name="ln1723">string MasterPathHandlers::RegistrationToHtml(</a>
<a name="ln1724">    const ServerRegistrationPB&amp; reg, const std::string&amp; link_text) const {</a>
<a name="ln1725">  string link_html = EscapeForHtmlToString(link_text);</a>
<a name="ln1726">  if (reg.http_addresses().size() &gt; 0) {</a>
<a name="ln1727">    link_html = Substitute(&quot;&lt;a href=\&quot;http://$0/\&quot;&gt;$1&lt;/a&gt;&quot;,</a>
<a name="ln1728">                           HostPortPBToString(reg.http_addresses(0)),</a>
<a name="ln1729">                           link_html);</a>
<a name="ln1730">  }</a>
<a name="ln1731">  return link_html;</a>
<a name="ln1732">}</a>
<a name="ln1733"> </a>
<a name="ln1734">void MasterPathHandlers::CalculateTabletMap(TabletCountMap* tablet_map) {</a>
<a name="ln1735">  vector&lt;scoped_refptr&lt;TableInfo&gt;&gt; tables;</a>
<a name="ln1736">  master_-&gt;catalog_manager()-&gt;GetAllTables(&amp;tables, true /* include only running tables */);</a>
<a name="ln1737">  for (const auto&amp; table : tables) {</a>
<a name="ln1738">    if (master_-&gt;catalog_manager()-&gt;IsColocatedUserTable(*table)) {</a>
<a name="ln1739">      // will be taken care of by colocated parent table</a>
<a name="ln1740">      continue;</a>
<a name="ln1741">    }</a>
<a name="ln1742"> </a>
<a name="ln1743">    TabletInfos tablets;</a>
<a name="ln1744">    table-&gt;GetAllTablets(&amp;tablets);</a>
<a name="ln1745">    bool is_user_table = master_-&gt;catalog_manager()-&gt;IsUserCreatedTable(*table);</a>
<a name="ln1746"> </a>
<a name="ln1747">    for (const auto&amp; tablet : tablets) {</a>
<a name="ln1748">      TabletInfo::ReplicaMap replication_locations;</a>
<a name="ln1749">      tablet-&gt;GetReplicaLocations(&amp;replication_locations);</a>
<a name="ln1750"> </a>
<a name="ln1751">      for (const auto&amp; replica : replication_locations) {</a>
<a name="ln1752">        if (is_user_table || master_-&gt;catalog_manager()-&gt;IsColocatedParentTable(*table)</a>
<a name="ln1753">                          || master_-&gt;catalog_manager()-&gt;IsTablegroupParentTable(*table)) {</a>
<a name="ln1754">          if (replica.second.role == consensus::RaftPeerPB_Role_LEADER) {</a>
<a name="ln1755">            (*tablet_map)[replica.first].user_tablet_leaders++;</a>
<a name="ln1756">          } else {</a>
<a name="ln1757">            (*tablet_map)[replica.first].user_tablet_followers++;</a>
<a name="ln1758">          }</a>
<a name="ln1759">        } else {</a>
<a name="ln1760">          if (replica.second.role == consensus::RaftPeerPB_Role_LEADER) {</a>
<a name="ln1761">            (*tablet_map)[replica.first].system_tablet_leaders++;</a>
<a name="ln1762">          } else {</a>
<a name="ln1763">            (*tablet_map)[replica.first].system_tablet_followers++;</a>
<a name="ln1764">          }</a>
<a name="ln1765">        }</a>
<a name="ln1766">      }</a>
<a name="ln1767">    }</a>
<a name="ln1768">  }</a>
<a name="ln1769">}</a>
<a name="ln1770"> </a>
<a name="ln1771">} // namespace master</a>
<a name="ln1772">} // namespace yb</a>

</code></pre>
<div class="balloon" rel="80"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v521/" target="_blank">V521</a> Such expressions using the ',' operator are dangerous. Make sure the expression is correct.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
